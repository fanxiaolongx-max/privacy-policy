<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å…¨èƒ½å·¥å…·ç®± - ç™½åº•æ‹¼æ¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        /* é€šç”¨æ ·å¼ */
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .preset-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }

        /* === ç¼–è¾‘/æ’åºå¡ç‰‡æ ·å¼ === */
        .page-card { transition: all 0.2s; cursor: grab; position: relative; user-select: none; }
        .page-card:active { cursor: grabbing; }
        .page-card.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
        .page-card.selected { ring: 2px solid #3b82f6; background-color: #eff6ff; }
        .check-indicator { display: none; }
        .page-card.selected .check-indicator { display: flex; }

        /* === æ‹¼æ¥åŠŸèƒ½æ ·å¼ === */
        .stitch-card { cursor: pointer; transition: all 0.2s; }
        .stitch-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stitch-card.selected-1 { ring: 2px solid #ef4444; background-color: #fef2f2; }
        .stitch-card.selected-2 { ring: 2px solid #3b82f6; background-color: #eff6ff; }
        .badge-order { position: absolute; top: 0.5rem; left: 0.5rem; width: 1.5rem; height: 1.5rem; border-radius: 9999px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; z-index: 10; }
        .bg-badge-1 { background-color: #ef4444; } 
        .bg-badge-2 { background-color: #3b82f6; } 

        /* === è£åˆ‡å™¨æ ·å¼ (æ”¯æŒæ‹–æ‹½ï¼Œå¢åŠ ç™½åº•) === */
        #cropper-frame { 
            /* èƒŒæ™¯çº¹ç†æ”¹ä¸ºçº¯ç™½ï¼Œå› ä¸ºç”»å¸ƒæœ¬èº«å·²ç»æ˜¯ç™½åº•äº† */
            background: white;
            cursor: grab; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #cropper-frame:active { cursor: grabbing; }
        #cropper-container { position: relative; overflow: hidden; border: 1px solid #e5e7eb; user-select: none; touch-action: none; margin: 0 auto; background: white; }
        
        #layer-base { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; overflow: hidden; background: white; } 
        #layer-top-wrapper { position: absolute; top: 0; left: 0; overflow: hidden; z-index: 2; background: transparent; pointer-events: none; }
        
        /* ç”»å¸ƒé»˜è®¤èƒŒæ™¯è®¾ä¸ºç™½è‰² */
        #cvs-top, #cvs-base { position: absolute; top: 0; left: 0; transform-origin: 0 0; background: white; }
        
        #split-line { position: absolute; z-index: 10; background-color: #3b82f6; pointer-events: none; }
        
        #drag-handle {
            position: absolute; z-index: 20; display: flex; align-items: center; justify-content: center;
            background-color: #3b82f6; color: white; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            width: 40px; height: 40px; border-radius: 50%;
            transition: box-shadow 0.2s;
        }
        #drag-handle:active { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.5); cursor: grabbing !important; }
        .handle-h { top: 50%; transform: translate(-50%, -50%); cursor: col-resize; }
        .handle-v { left: 50%; transform: translate(-50%, -50%); cursor: row-resize; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-gray-700">

    <div class="max-w-6xl mx-auto py-8 px-4">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">PDF æœ¬åœ°å·¥å…·ç®±</h1>
            <p class="text-sm text-gray-500">ç¦»çº¿å¤„ç† Â· æ•°æ®å®‰å…¨ Â· çº¯æµè§ˆå™¨è¿è¡Œ</p>
        </div>

        <div class="flex flex-wrap justify-center mb-6 gap-2">
            <div class="bg-white p-1 rounded-lg shadow-sm inline-flex border border-gray-200 overflow-hidden">
                <button onclick="switchTab('compress')" id="tab-compress" class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all">å‹ç¼©ç˜¦èº«</button>
                <button onclick="switchTab('merge')" id="tab-merge" class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all">å¤šæ–‡ä»¶åˆå¹¶</button>
                <button onclick="switchTab('editor')" id="tab-editor" class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all">æ’åº/æ—‹è½¬</button>
                <button onclick="switchTab('stitch')" id="tab-stitch" class="tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-purple-600 bg-purple-50">åŒé¡µæ‹¼æ¥</button>
            </div>
        </div>

        <div id="view-compress" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div class="max-w-xl mx-auto">
                <div id="comp-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-gray-50 transition-all">
                    <input type="file" id="comp-file-input" accept="application/pdf" class="hidden">
                    <div class="space-y-2"><div class="text-4xl">ğŸ—œï¸</div><p class="text-lg font-medium">ç‚¹å‡»ä¸Šä¼  PDF (å‹ç¼©)</p></div>
                </div>
                <div id="comp-settings" class="mt-6 hidden space-y-6">
                     <div class="grid grid-cols-3 gap-3">
                        <button onclick="applyPreset(0.9, 1.9, this)" class="preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300">
                            <div class="font-bold text-sm text-gray-800">è½»åº¦å‹ç¼©</div><div class="text-xs text-gray-400 mt-1">ç”»è´¨ä¼˜å…ˆ</div>
                        </button>
                        <button onclick="applyPreset(0.8, 1.8, this)" class="preset-btn active border border-blue-500 bg-blue-50 text-blue-600 rounded-lg p-3 text-center">
                            <div class="font-bold text-sm">æ¨èå‹ç¼©</div><div class="text-xs opacity-75 mt-1">å‡è¡¡æ¨¡å¼</div>
                        </button>
                        <button onclick="applyPreset(0.7, 1.6, this)" class="preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300">
                            <div class="font-bold text-sm text-gray-800">å¼ºåŠ›ç˜¦èº«</div><div class="text-xs text-gray-400 mt-1">æé™ä½“ç§¯</div>
                        </button>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 grid grid-cols-2 gap-6">
                        <div><label class="text-xs font-bold text-gray-500">å›¾ç‰‡è´¨é‡ <span id="q-val" class="text-blue-600">0.8</span></label><input type="range" id="quality" min="0.1" max="1.0" step="0.1" value="0.8" class="w-full accent-blue-600" oninput="updateVal('q', this.value)"></div>
                        <div><label class="text-xs font-bold text-gray-500">ç¼©æ”¾æ¯”ä¾‹ <span id="s-val" class="text-blue-600">1.8x</span></label><input type="range" id="scale" min="0.5" max="2.0" step="0.1" value="1.8" class="w-full accent-blue-600" oninput="updateVal('s', this.value)"></div>
                    </div>
                    <button id="btn-start-compress" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md">å¼€å§‹å‹ç¼©</button>
                </div>
                <div id="comp-result" class="hidden mt-6 text-center">
                    <div class="spinner mx-auto mb-4"></div><p id="comp-status" class="mb-2 text-sm text-gray-600">å¤„ç†ä¸­...</p>
                    <div id="comp-actions" class="hidden space-y-3"><a id="comp-download" class="inline-block w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold">ä¸‹è½½å‹ç¼©æ–‡ä»¶</a><button onclick="resetCompress()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 px-6 py-2 rounded-lg text-sm font-medium">å‹ç¼©ä¸‹ä¸€ä¸ªæ–‡ä»¶</button></div>
                </div>
            </div>
        </div>

        <div id="view-merge" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4 gap-2">
                    <h3 class="font-bold">åˆå¹¶åˆ—è¡¨</h3>
                    <div class="flex gap-2"><button onclick="clearMergeList()" class="text-red-500 text-sm border border-red-200 px-3 py-1 rounded bg-red-50">æ¸…ç©º</button><button onclick="document.getElementById('merge-input').click()" class="text-blue-600 text-sm border border-blue-200 px-3 py-1 rounded bg-blue-50">+ æ·»åŠ </button></div>
                    <input type="file" id="merge-input" accept="application/pdf" multiple class="hidden">
                </div>
                <ul id="merge-list" class="space-y-2 min-h-[100px] border-2 border-dashed border-gray-100 rounded-lg p-4 mb-4"><li class="text-center text-gray-400 text-sm py-4">æš‚æ— æ–‡ä»¶</li></ul>
                <button id="btn-start-merge" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg hidden shadow-md">åˆå¹¶å¹¶ä¸‹è½½</button>
            </div>
        </div>

        <div id="view-editor" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div id="edit-upload-area" class="max-w-xl mx-auto border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-purple-400 hover:bg-gray-50 transition-all">
                <input type="file" id="edit-file-input" accept="application/pdf" class="hidden">
                <div class="text-4xl mb-2">ğŸ“„</div>
                <p class="text-lg font-medium text-gray-700">ç‚¹å‡»ä¸Šä¼  PDF (é¡µé¢ç¼–è¾‘)</p>
                <p class="text-xs text-gray-400">æ”¯æŒæ’åºã€æ—‹è½¬ã€åˆ é™¤é¡µé¢</p>
            </div>

            <div id="edit-work-area" class="hidden">
                <div class="sticky top-0 bg-white z-20 py-3 border-b shadow-sm mb-4 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <div class="flex gap-2 items-center">
                        <button onclick="resetEditor()" class="text-sm px-3 py-1 border rounded hover:bg-gray-50 flex items-center gap-1">â† é‡ä¼ </button>
                        <span class="text-gray-300">|</span>
                        <button onclick="toggleSelectAll()" id="btn-select-all" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">å…¨é€‰</button>
                        <button onclick="rotateSelected(-90)" class="text-sm px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded">é€‰ä¸­å·¦æ—‹</button>
                        <button onclick="rotateSelected(90)" class="text-sm px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded">é€‰ä¸­å³æ—‹</button>
                    </div>
                    <button id="btn-save-order" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-2 rounded shadow-md text-sm transition-colors">ä¿å­˜ PDF</button>
                </div>
                <div id="pages-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 p-2 bg-gray-50 rounded-lg min-h-[400px]"></div>
            </div>
        </div>

        <div id="view-stitch" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div id="stitch-upload-area" class="max-w-xl mx-auto border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-pink-400 hover:bg-gray-50 transition-all">
                <input type="file" id="stitch-file-input" accept="application/pdf" class="hidden">
                <div class="text-4xl mb-2">âœ‚ï¸</div>
                <p class="text-lg font-medium text-gray-700">ç‚¹å‡»ä¸Šä¼  PDF (è£åˆ‡æ‹¼æ¥)</p>
                <p class="text-xs text-gray-400">é€‰æ‹© 2 é¡µï¼Œè‡ªç”±æ‹–åŠ¨æ’ç‰ˆ</p>
            </div>

            <div id="stitch-select-area" class="hidden">
                <div class="sticky top-0 bg-white z-20 py-4 border-b shadow-sm mb-4 flex justify-between items-center">
                    <div><span class="font-bold text-gray-700">é€‰æ‹© 2 ä¸ªé¡µé¢ï¼š</span><span id="stitch-status" class="text-gray-500">å·²é€‰ 0/2</span></div>
                    <div class="flex gap-2">
                        <button onclick="resetStitch()" class="text-sm px-3 py-1 border rounded hover:bg-gray-50">é‡ç½®</button>
                        <button onclick="goToCropper()" id="btn-to-cropper" class="px-4 py-1 bg-pink-600 text-white rounded shadow-sm text-sm font-bold opacity-50 cursor-not-allowed" disabled>ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>
                <div id="stitch-grid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-5 gap-4 p-2 bg-gray-50 rounded-lg min-h-[300px]"></div>
            </div>

            <div id="stitch-cropper-area" class="hidden text-center select-none">
                <div class="mb-4 flex flex-col md:flex-row justify-between items-center bg-gray-50 p-2 rounded gap-2">
                    <button onclick="exitCropper()" class="text-sm text-gray-600 px-3 py-1 hover:bg-gray-200 rounded">â† è¿”å›</button>
                    <div class="flex bg-white rounded border overflow-hidden">
                        <button onclick="setSplitMode('horizontal')" id="mode-h" class="px-3 py-1 text-xs font-bold bg-blue-100 text-blue-700">å·¦å³æ‹¼æ¥</button>
                        <button onclick="setSplitMode('vertical')" id="mode-v" class="px-3 py-1 text-xs font-bold text-gray-500 hover:bg-gray-50">ä¸Šä¸‹æ‹¼æ¥</button>
                    </div>
                    <button onclick="doStitchSave()" id="btn-final-save" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow-md text-sm">ä¿å­˜ PDF</button>
                </div>

                <div class="flex justify-center gap-4 text-xs text-gray-500 mb-2">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> æ‹–åŠ¨è“ç‚¹è°ƒæ•´è£åˆ‡çº¿</span>
                    <span class="flex items-center gap-1">âœ‹ æ‹–åŠ¨å›¾ç‰‡è°ƒæ•´ä½ç½®</span>
                </div>
                
                <div id="cropper-frame" class="inline-block relative rounded border border-gray-200 overflow-hidden">
                    <div id="cropper-container" style="width: 0px; height: 0px;">
                        <div id="layer-base"><canvas id="cvs-base"></canvas></div>
                        <div id="layer-top-wrapper"><div id="layer-top"><canvas id="cvs-top"></canvas></div></div>
                        <div id="split-line"></div>
                        <div id="drag-handle" class="handle-h"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.className = 'tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700');
            const color = { 'compress': 'blue', 'merge': 'indigo', 'editor': 'purple', 'stitch': 'pink' }[tab];
            document.getElementById(`tab-${tab}`).className = `tab-btn px-4 py-2 rounded-md text-sm font-medium transition-all bg-${color}-50 text-${color}-600 shadow-sm ring-1 ring-${color}-200`;
        }
        switchTab('compress');
        function formatBytes(b){if(b==0)return'0 B';const s=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(1024));return parseFloat((b/Math.pow(1024,i)).toFixed(2))+' '+s[i]}

        // === 1. å‹ç¼© (é€»è¾‘æŠ˜å ) ===
        const compInput=document.getElementById('comp-file-input');let compFile=null;
        window.applyPreset=(q,s,btn)=>{document.getElementById('quality').value=q;document.getElementById('scale').value=s;updateVal('q',q);updateVal('s',s);document.querySelectorAll('.preset-btn').forEach(b=>{b.className='preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300';b.querySelector('.font-bold').className='font-bold text-sm text-gray-800';b.querySelector('.text-xs').className='text-xs text-gray-400 mt-1'});btn.className='preset-btn active border border-blue-500 bg-blue-50 text-blue-600 rounded-lg p-3 text-center';btn.querySelector('.font-bold').className='font-bold text-sm';btn.querySelector('.text-xs').className='text-xs opacity-75 mt-1'};
        window.updateVal=(t,v)=>{if(t==='q')document.getElementById('q-val').innerText=v;if(t==='s')document.getElementById('s-val').innerText=v+'x'};
        window.resetCompress=()=>{compFile=null;compInput.value='';document.getElementById('comp-drop-zone').classList.remove('hidden');document.getElementById('comp-settings').classList.add('hidden');document.getElementById('comp-result').classList.add('hidden');document.getElementById('comp-actions').classList.add('hidden');document.querySelector('#comp-result .spinner').classList.remove('hidden')};
        document.getElementById('comp-drop-zone').onclick=()=>compInput.click();
        compInput.onchange=(e)=>{if(e.target.files[0]){if(!document.getElementById('comp-result').classList.contains('hidden'))resetCompress();compFile=e.target.files[0];document.getElementById('comp-drop-zone').classList.add('hidden');document.getElementById('comp-settings').classList.remove('hidden')}};
        document.getElementById('btn-start-compress').onclick=async()=>{if(!compFile)return;const status=document.getElementById('comp-status');const dl=document.getElementById('comp-actions');const lnk=document.getElementById('comp-download');const spin=document.querySelector('#comp-result .spinner');document.getElementById('comp-result').classList.remove('hidden');document.getElementById('comp-settings').classList.add('hidden');spin.classList.remove('hidden');dl.classList.add('hidden');try{const buf=await compFile.arrayBuffer();const pdf=await pdfjsLib.getDocument({data:buf}).promise;const newPdf=await PDFLib.PDFDocument.create();const q=parseFloat(document.getElementById('quality').value);const s=parseFloat(document.getElementById('scale').value);for(let i=1;i<=pdf.numPages;i++){status.innerText=`å¤„ç†é¡µé¢: ${i}/${pdf.numPages}`;const p=await pdf.getPage(i);const vp=p.getViewport({scale:s});const cvs=document.createElement('canvas');cvs.width=vp.width;cvs.height=vp.height;await p.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;const img=await newPdf.embedJpg(cvs.toDataURL('image/jpeg',q));newPdf.addPage([vp.width,vp.height]).drawImage(img,{x:0,y:0,width:vp.width,height:vp.height})}status.innerText="æ‰“åŒ…ä¸­...";const bytes=await newPdf.save();const blob=new Blob([bytes],{type:'application/pdf'});spin.classList.add('hidden');lnk.href=URL.createObjectURL(blob);lnk.download='compressed_'+compFile.name;dl.classList.remove('hidden');status.innerHTML='å®Œæˆ!';}catch(e){alert('Err:'+e.message);resetCompress()}};

        // === 2. åˆå¹¶ (é€»è¾‘æŠ˜å ) ===
        let mergeFiles=[];const mergeInput=document.getElementById('merge-input'),mergeList=document.getElementById('merge-list'),btnMerge=document.getElementById('btn-start-merge');
        window.clearMergeList=()=>{mergeFiles=[];renderMergeList();mergeInput.value=''};mergeInput.onchange=(e)=>{mergeFiles=[...mergeFiles,...Array.from(e.target.files)];renderMergeList();btnMerge.classList.remove('hidden');mergeInput.value=''};
        function renderMergeList(){if(mergeFiles.length==0){mergeList.innerHTML='<li class="text-center text-gray-400 text-sm py-4">æš‚æ— æ–‡ä»¶</li>';btnMerge.classList.add('hidden');return}mergeList.innerHTML=mergeFiles.map((f,i)=>`<li class="flex justify-between items-center bg-gray-50 p-2 rounded border"><span class="truncate text-sm w-40">${i+1}. ${f.name}</span><div class="flex gap-1"><button onclick="moveMerge(${i},-1)" class="p-1" ${i==0?'disabled':''}>â†‘</button><button onclick="moveMerge(${i},1)" class="p-1" ${i==mergeFiles.length-1?'disabled':''}>â†“</button><button onclick="removeMerge(${i})" class="p-1 text-red-500">Ã—</button></div></li>`).join('')}
        window.moveMerge=(i,d)=>{if(i+d>=0&&i+d<mergeFiles.length){[mergeFiles[i],mergeFiles[i+d]]=[mergeFiles[i+d],mergeFiles[i]];renderMergeList()}};window.removeMerge=(i)=>{mergeFiles.splice(i,1);renderMergeList()};
        btnMerge.onclick=async()=>{const btn=document.getElementById('btn-start-merge');btn.innerText='åˆå¹¶ä¸­...';btn.disabled=true;try{const newPdf=await PDFLib.PDFDocument.create();for(let f of mergeFiles){const pdf=await PDFLib.PDFDocument.load(await f.arrayBuffer());(await newPdf.copyPages(pdf,pdf.getPageIndices())).forEach(p=>newPdf.addPage(p))}const blob=new Blob([await newPdf.save()],{type:'application/pdf'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='merged.pdf';a.click()}catch(e){alert('Err:'+e.message)}finally{btn.innerText='åˆå¹¶å¹¶ä¸‹è½½';btn.disabled=false}};

        // === 3. ç¼–è¾‘ (ä¿æŒä¸å˜) ===
        const editInput=document.getElementById('edit-file-input'),editZone=document.getElementById('edit-upload-area'),editWork=document.getElementById('edit-work-area'),grid=document.getElementById('pages-grid');let currentEditFile=null;
        window.resetEditor=()=>{currentEditFile=null;grid.innerHTML='Loading...';editWork.classList.add('hidden');editZone.classList.remove('hidden');editInput.value=''};editZone.onclick=()=>editInput.click();
        
        editInput.onchange = async (e) => {
            const f = e.target.files[0];
            if(!f) return;
            currentEditFile = f;
            editZone.classList.add('hidden');
            editWork.classList.remove('hidden');
            const buf = await f.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:buf}).promise;
            
            grid.innerHTML = '';
            for(let i=1; i<=pdf.numPages; i++){
                const p = await pdf.getPage(i);
                const vp = p.getViewport({scale:0.25});
                const cvs = document.createElement('canvas');
                cvs.width=vp.width; cvs.height=vp.height;
                await p.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;
                
                const div = document.createElement('div');
                div.className = 'page-card bg-white border border-gray-200 shadow-sm rounded-lg p-2 flex flex-col items-center select-none group relative';
                div.draggable = true;
                div.dataset.idx = i-1;
                div.dataset.rot = 0;
                
                div.innerHTML = `
                    <div class="check-indicator absolute top-2 right-2 bg-blue-600 text-white rounded-full p-0.5 hidden z-10 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <div class="relative w-full h-40 flex items-center justify-center bg-gray-100 mb-2 overflow-hidden rounded cursor-pointer" onclick="toggleSelect(this)">
                        <img src="${cvs.toDataURL()}" class="max-w-full max-h-full object-contain pointer-events-none transition-transform duration-200" style="transform: rotate(0deg)">
                    </div>
                    
                    <div class="w-full">
                        <div class="text-center text-xs font-bold text-gray-500 mb-2">ç¬¬ ${i} é¡µ</div>
                        <div class="flex justify-between gap-1 w-full">
                             <button onclick="rotateCard(this, -90)" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 py-1 rounded text-xs border border-blue-100 font-medium">â†º å·¦æ—‹</button>
                             <button onclick="rotateCard(this, 90)" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 py-1 rounded text-xs border border-blue-100 font-medium">â†» å³æ—‹</button>
                             <button onclick="this.closest('.page-card').remove()" class="px-2 bg-red-50 hover:bg-red-100 text-red-500 rounded border border-red-100" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
                addDnDEvents(div);
                grid.appendChild(div);
            }
        };

        window.rotateCard=(btn,d)=>{const c=btn.closest('.page-card'),img=c.querySelector('img');let r=parseInt(c.dataset.rot)+d;c.dataset.rot=r;img.style.transform=`rotate(${r}deg)`};
        window.toggleSelect=(el)=>{el.closest('.page-card').classList.toggle('selected')};
        window.toggleSelectAll=()=>{const cs=document.querySelectorAll('.page-card'),all=Array.from(cs).every(c=>c.classList.contains('selected'));cs.forEach(c=>{if(all)c.classList.remove('selected');else c.classList.add('selected')})};
        window.rotateSelected=(d)=>{const cs=document.querySelectorAll('.page-card.selected');if(!cs.length)return alert('è¯·å…ˆç‚¹å›¾ç‰‡é€‰ä¸­');cs.forEach(c=>{let r=parseInt(c.dataset.rot)+d;c.dataset.rot=r;c.querySelector('img').style.transform=`rotate(${r}deg)`})};
        let dragSrc=null;function addDnDEvents(el){el.addEventListener('dragstart',function(e){dragSrc=this;e.dataTransfer.effectAllowed='move';this.classList.add('dragging')});el.addEventListener('dragend',function(){this.classList.remove('dragging')});el.addEventListener('dragover',function(e){if(e.preventDefault)e.preventDefault();return false});el.addEventListener('drop',function(e){if(e.stopPropagation)e.stopPropagation();if(dragSrc!==this){const all=[...grid.children],s=all.indexOf(dragSrc),t=all.indexOf(this);if(s<t)grid.insertBefore(dragSrc,this.nextSibling);else grid.insertBefore(dragSrc,this)}})};
        
        document.getElementById('btn-save-order').onclick=async()=>{if(!currentEditFile)return;const btn=document.getElementById('btn-save-order');btn.innerText='å¤„ç†ä¸­...';try{const buf=await currentEditFile.arrayBuffer();const src=await PDFLib.PDFDocument.load(buf);const newPdf=await PDFLib.PDFDocument.create();const cards=document.querySelectorAll('#pages-grid .page-card');if(!cards.length)return alert('è‡³å°‘ä¿ç•™ä¸€é¡µ');for(const c of cards){const idx=parseInt(c.dataset.idx),rot=parseInt(c.dataset.rot)||0;const [p]=await newPdf.copyPages(src,[idx]);const exRot=p.getRotation().angle;p.setRotation(PDFLib.degrees(exRot+rot));newPdf.addPage(p)}const b=new Blob([await newPdf.save()],{type:'application/pdf'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='edited.pdf';a.click()}catch(e){console.error(e);alert('ä¿å­˜å¤±è´¥')}finally{btn.innerText='ä¿å­˜ PDF'}};

        // ================= 4. åŒé¡µè£åˆ‡æ‹¼æ¥ (ä¿®å¤èƒŒæ™¯è‰²ä¸ºçº¯ç™½) =================
        const stitchInput = document.getElementById('stitch-file-input');
        const stitchZone = document.getElementById('stitch-upload-area');
        const stitchSelect = document.getElementById('stitch-select-area');
        const stitchCropper = document.getElementById('stitch-cropper-area');
        const stitchGrid = document.getElementById('stitch-grid');
        
        let stitchFile = null;
        let stitchPdfDoc = null;
        let stitchSelectedIdx = [];
        
        // Cropper Variables
        let cropperSplitRatio = 0.5;
        let cropperMode = 'horizontal';
        let canvasW = 0, canvasH = 0;
        let displayScale = 1;
        let p1Offset = {x: 0, y: 0};
        let p2Offset = {x: 0, y: 0};

        window.resetStitch = () => {
            stitchFile = null; stitchSelectedIdx = [];
            stitchInput.value = '';
            stitchZone.classList.remove('hidden');
            stitchSelect.classList.add('hidden');
            stitchCropper.classList.add('hidden');
        };

        stitchZone.onclick = () => stitchInput.click();

        stitchInput.onchange = async (e) => {
            const f = e.target.files[0]; if(!f) return;
            stitchFile = f;
            stitchZone.classList.add('hidden');
            stitchSelect.classList.remove('hidden');
            
            const buf = await f.arrayBuffer();
            stitchPdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
            
            stitchGrid.innerHTML = '';
            for(let i=1; i<=stitchPdfDoc.numPages; i++){
                const p = await stitchPdfDoc.getPage(i);
                const vp = p.getViewport({scale:0.2});
                const cvs = document.createElement('canvas');
                cvs.width=vp.width; cvs.height=vp.height;
                await p.render({canvasContext:cvs.getContext('2d'),viewport:vp}).promise;
                const div = document.createElement('div');
                div.className = 'stitch-card bg-white border p-2 flex flex-col items-center cursor-pointer relative';
                div.onclick = () => toggleStitchSelect(i-1);
                div.dataset.idx = i-1;
                div.innerHTML = `<div class="badge-order hidden"></div><img src="${cvs.toDataURL()}"><span class="text-xs font-bold mt-1">P${i}</span>`;
                stitchGrid.appendChild(div);
            }
            updateStitchSelectUI();
        };

        window.toggleStitchSelect = (idx) => {
            const pos = stitchSelectedIdx.indexOf(idx);
            if(pos !== -1) stitchSelectedIdx.splice(pos, 1);
            else {
                if(stitchSelectedIdx.length < 2) stitchSelectedIdx.push(idx);
                else { stitchSelectedIdx.shift(); stitchSelectedIdx.push(idx); }
            }
            updateStitchSelectUI();
        };

        function updateStitchSelectUI() {
            document.getElementById('stitch-status').innerText = `å·²é€‰ ${stitchSelectedIdx.length}/2`;
            const btn = document.getElementById('btn-to-cropper');
            if(stitchSelectedIdx.length === 2) {
                btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            document.querySelectorAll('.stitch-card').forEach(c => {
                const i = parseInt(c.dataset.idx);
                const order = stitchSelectedIdx.indexOf(i);
                const badge = c.querySelector('.badge-order');
                c.classList.remove('selected-1', 'selected-2');
                badge.classList.add('hidden');
                if(order !== -1) {
                    c.classList.add(order === 0 ? 'selected-1' : 'selected-2');
                    badge.classList.remove('hidden');
                    badge.className = `badge-order ${order === 0 ? 'bg-badge-1' : 'bg-badge-2'}`;
                    badge.innerText = order + 1;
                }
            });
        }

        window.goToCropper = async () => {
            stitchSelect.classList.add('hidden');
            stitchCropper.classList.remove('hidden');
            cropperSplitRatio = 0.5;
            p1Offset = {x:0, y:0};
            p2Offset = {x:0, y:0};
            await initCropperCanvases();
        };

        window.exitCropper = () => {
            stitchCropper.classList.add('hidden');
            stitchSelect.classList.remove('hidden');
        };

        async function initCropperCanvases() {
            const scale = 2.0; 
            const page1 = await stitchPdfDoc.getPage(stitchSelectedIdx[0] + 1);
            const page2 = await stitchPdfDoc.getPage(stitchSelectedIdx[1] + 1);
            const vp1 = page1.getViewport({scale: scale});
            
            canvasW = vp1.width; canvasH = vp1.height;
            const container = document.getElementById('cropper-container');
            const displayWidth = Math.min(window.innerWidth - 40, 600); 
            displayScale = displayWidth / canvasW;
            const displayHeight = canvasH * displayScale;
            container.style.width = displayWidth + 'px';
            container.style.height = displayHeight + 'px';

            // åˆå§‹åŒ– Top Canvas (P1) - å¡«å……ç™½è‰²èƒŒæ™¯
            const c1 = document.getElementById('cvs-top');
            c1.width = canvasW; c1.height = canvasH;
            c1.style.width = displayWidth + 'px'; c1.style.height = displayHeight + 'px';
            c1.style.transform = `translate(0px, 0px)`;
            const ctx1 = c1.getContext('2d');
            ctx1.fillStyle = 'white'; ctx1.fillRect(0, 0, canvasW, canvasH); // å…³é”®ï¼šå¡«å……ç™½åº•
            await page1.render({canvasContext: ctx1, viewport: vp1}).promise;

            // åˆå§‹åŒ– Base Canvas (P2) - å¡«å……ç™½è‰²èƒŒæ™¯
            const c2 = document.getElementById('cvs-base');
            c2.width = canvasW; c2.height = canvasH;
            c2.style.width = displayWidth + 'px'; c2.style.height = displayHeight + 'px';
            c2.style.transform = `translate(0px, 0px)`;
            
            const tempCvs = document.createElement('canvas');
            const vp2_render = page2.getViewport({scale: scale}); 
            tempCvs.width = vp2_render.width; tempCvs.height = vp2_render.height;
            await page2.render({canvasContext: tempCvs.getContext('2d'), viewport: vp2_render}).promise;
            
            const ctx2 = c2.getContext('2d');
            ctx2.fillStyle = 'white'; ctx2.fillRect(0,0,canvasW,canvasH); // å…³é”®ï¼šå¡«å……ç™½åº•
            ctx2.drawImage(tempCvs, 0, 0, tempCvs.width, tempCvs.height, 0, 0, canvasW, canvasH);
            
            updateSplitVisuals();
        }

        window.setSplitMode = (m) => {
            cropperMode = m;
            const hBtn = document.getElementById('mode-h');
            const vBtn = document.getElementById('mode-v');
            if(m === 'horizontal') {
                hBtn.className = "px-3 py-1 text-xs font-bold bg-blue-100 text-blue-700";
                vBtn.className = "px-3 py-1 text-xs font-bold text-gray-500 hover:bg-gray-50";
            } else {
                vBtn.className = "px-3 py-1 text-xs font-bold bg-blue-100 text-blue-700";
                hBtn.className = "px-3 py-1 text-xs font-bold text-gray-500 hover:bg-gray-50";
            }
            updateSplitVisuals();
        };

        function updateSplitVisuals() {
            const wrapper = document.getElementById('layer-top-wrapper');
            const line = document.getElementById('split-line');
            const handle = document.getElementById('drag-handle');
            
            if (cropperMode === 'horizontal') {
                wrapper.style.height = '100%';
                wrapper.style.width = (cropperSplitRatio * 100) + '%';
                wrapper.style.borderRight = 'none'; wrapper.style.borderBottom = 'none';
                line.style.width = '2px'; line.style.height = '100%'; line.style.top = 0; line.style.left = (cropperSplitRatio * 100) + '%';
                handle.className = 'handle-h';
                handle.style.left = (cropperSplitRatio * 100) + '%'; 
                handle.style.top = '50%';
                handle.innerHTML = '<svg class="w-4 h-4 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>';
            } else {
                wrapper.style.width = '100%';
                wrapper.style.height = (cropperSplitRatio * 100) + '%';
                wrapper.style.borderBottom = 'none'; wrapper.style.borderRight = 'none';
                line.style.height = '2px'; line.style.width = '100%'; line.style.left = 0; line.style.top = (cropperSplitRatio * 100) + '%';
                handle.className = 'handle-v';
                handle.style.top = (cropperSplitRatio * 100) + '%';
                handle.style.left = '50%';
                handle.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>';
            }
        }

        const handle = document.getElementById('drag-handle');
        const container = document.getElementById('cropper-container');
        let dragMode = null; 
        let dragStart = {x:0, y:0};
        let startOffset = {x:0, y:0};
        let activePage = 0; 

        handle.addEventListener('mousedown', (e) => startDrag(e, 'split'));
        handle.addEventListener('touchstart', (e) => startDrag(e, 'split'), {passive: false});
        container.addEventListener('mousedown', (e) => startDrag(e, 'pan'));
        container.addEventListener('touchstart', (e) => startDrag(e, 'pan'), {passive: false});

        function startDrag(e, mode) {
            e.preventDefault(); e.stopPropagation();
            dragMode = mode;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragStart = {x: clientX, y: clientY};

            if (mode === 'pan') {
                const rect = container.getBoundingClientRect();
                const relX = clientX - rect.left;
                const relY = clientY - rect.top;
                if (cropperMode === 'horizontal') {
                    activePage = (relX < rect.width * cropperSplitRatio) ? 1 : 2;
                } else {
                    activePage = (relY < rect.height * cropperSplitRatio) ? 1 : 2;
                }
                startOffset = (activePage === 1) ? {...p1Offset} : {...p2Offset};
                container.style.cursor = 'move';
            }
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, {passive: false});
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function onDrag(e) {
            if (!dragMode) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            if (dragMode === 'split') {
                const rect = container.getBoundingClientRect();
                if (cropperMode === 'horizontal') {
                    let x = clientX - rect.left;
                    cropperSplitRatio = Math.max(0.05, Math.min(0.95, x / rect.width));
                } else {
                    let y = clientY - rect.top;
                    cropperSplitRatio = Math.max(0.05, Math.min(0.95, y / rect.height));
                }
                updateSplitVisuals();
            } 
            else if (dragMode === 'pan') {
                const deltaX = clientX - dragStart.x;
                const deltaY = clientY - dragStart.y;
                if (activePage === 1) {
                    p1Offset.x = startOffset.x + deltaX;
                    p1Offset.y = startOffset.y + deltaY;
                    document.getElementById('cvs-top').style.transform = `translate(${p1Offset.x}px, ${p1Offset.y}px)`;
                } else {
                    p2Offset.x = startOffset.x + deltaX;
                    p2Offset.y = startOffset.y + deltaY;
                    document.getElementById('cvs-base').style.transform = `translate(${p2Offset.x}px, ${p2Offset.y}px)`;
                }
            }
        }

        function stopDrag() {
            dragMode = null;
            container.style.cursor = 'default';
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        window.doStitchSave = async () => {
            const btn = document.getElementById('btn-final-save'); btn.innerText = 'ç”Ÿæˆä¸­...';
            try {
                const finalCvs = document.createElement('canvas'); finalCvs.width = canvasW; finalCvs.height = canvasH;
                const ctx = finalCvs.getContext('2d');
                
                // å…³é”®ï¼šæœ€ç»ˆç”»å¸ƒå¡«å……ç™½åº•
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvasW, canvasH);

                const c1 = document.getElementById('cvs-top'); const c2 = document.getElementById('cvs-base');
                
                const p1X = p1Offset.x / displayScale;
                const p1Y = p1Offset.y / displayScale;
                const p2X = p2Offset.x / displayScale;
                const p2Y = p2Offset.y / displayScale;

                if (cropperMode === 'horizontal') {
                    const splitX = canvasW * cropperSplitRatio;
                    ctx.save(); ctx.beginPath(); ctx.rect(0, 0, splitX, canvasH); ctx.clip();
                    ctx.drawImage(c1, p1X, p1Y); ctx.restore();
                    ctx.save(); ctx.beginPath(); ctx.rect(splitX, 0, canvasW - splitX, canvasH); ctx.clip();
                    ctx.drawImage(c2, p2X, p2Y); ctx.restore();
                } else {
                    const splitY = canvasH * cropperSplitRatio;
                    ctx.save(); ctx.beginPath(); ctx.rect(0, 0, canvasW, splitY); ctx.clip();
                    ctx.drawImage(c1, p1X, p1Y); ctx.restore();
                    ctx.save(); ctx.beginPath(); ctx.rect(0, splitY, canvasW, canvasH - splitY); ctx.clip();
                    ctx.drawImage(c2, p2X, p2Y); ctx.restore();
                }
                const newPdf = await PDFLib.PDFDocument.create();
                const jpgData = finalCvs.toDataURL('image/jpeg', 0.9);
                const embeddedImg = await newPdf.embedJpg(jpgData);
                const page = newPdf.addPage([canvasW / 2.0, canvasH / 2.0]);
                page.drawImage(embeddedImg, { x: 0, y: 0, width: canvasW / 2.0, height: canvasH / 2.0 });
                const blob = new Blob([await newPdf.save()], { type: 'application/pdf' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'stitched.pdf'; a.click();
            } catch(e) { alert('å‡ºé”™: ' + e.message); console.error(e); } finally { btn.innerText = 'ä¿å­˜ PDF'; }
        };
    </script>
</body>
</html>
