<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµæµªå’ª - ç¤¾åŒºåœ°å›¾</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #FF9F43;
            --bg: #F7F8FA;
            --text: #2d3436;
            --gray: #b2bec3;
            --white: #ffffff;
            --shadow: 0 4px 20px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* é¡¶éƒ¨æ  */
        header {
            background: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            height: 56px; z-index: 1000; box-shadow: 0 1px 5px rgba(0,0,0,0.03);
        }
        .brand { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 6px; }
        .view-toggle { background: #f1f2f6; border-radius: 18px; padding: 3px; display: flex; }
        .toggle-btn { border: none; background: transparent; padding: 4px 12px; border-radius: 15px; font-size: 13px; color: #636e72; transition: 0.2s; }
        .toggle-btn.active { background: var(--white); color: var(--primary); font-weight: 600; shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* ä¸»è§†å›¾ */
        main { flex: 1; position: relative; overflow: hidden; }
        #map-container { width: 100%; height: 100%; z-index: 1; }

        /* åœ°å›¾æ ‡è®° */
        .cat-marker {
            width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--white);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); overflow: hidden; background: #eee; position: relative;
            transition: transform 0.2s;
        }
        .cat-marker:active { transform: scale(1.1); }
        .cat-marker img { width: 100%; height: 100%; object-fit: cover; }
        .cat-marker::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            border-width: 5px 5px 0; border-style: solid; border-color: var(--white) transparent transparent transparent;
        }

        /* åˆ—è¡¨é¡¹ */
        #list-container { display: none; height: 100%; overflow-y: auto; padding: 12px; background: var(--bg); padding-bottom: 80px;}
        .cat-card {
            background: var(--white); border-radius: 12px; padding: 12px; margin-bottom: 10px;
            display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            transition: background 0.2s;
        }
        .cat-card:active { background: #f0f0f0; }
        .cat-card img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background: #eee; }
        .cat-info { flex: 1; min-width: 0; }
        .cat-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .cat-name { font-size: 16px; font-weight: bold; color: #333; }
        .cat-status { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e0f2f1; color: #009688; }
        .cat-detail-row { font-size: 12px; color: #888; display: flex; gap: 8px; margin-top: 4px; }
        
        /* è¯¦æƒ…é¡µ Bottom Sheet */
        .bottom-sheet {
            position: fixed; left: 0; right: 0; bottom: 0;
            background: var(--white); z-index: 2000;
            border-radius: 20px 20px 0 0;
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.2, 0.9, 0.3, 1);
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .bottom-sheet.open { transform: translateY(0); }
        .sheet-handle { width: 36px; height: 4px; background: #e0e0e0; border-radius: 2px; margin: 10px auto; flex-shrink: 0; }
        .sheet-scroll { overflow-y: auto; padding: 0 20px 20px; }

        /* ç®€æ´ç‰ˆè¯¦æƒ…å¸ƒå±€ */
        .d-hero { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; }
        .d-avatar { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; border: 1px solid #eee; }
        .d-header h2 { font-size: 20px; margin-bottom: 5px; }
        .d-id { font-size: 12px; color: #999; font-family: monospace; background: #f5f5f5; padding: 2px 5px; border-radius: 4px; }
        
        /* å±æ€§ç½‘æ ¼ */
        .d-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .d-grid-item { background: #F8F9FA; padding: 10px; border-radius: 8px; text-align: center; }
        .d-label { font-size: 11px; color: #999; margin-bottom: 2px; }
        .d-val { font-size: 14px; font-weight: 600; color: #333; }
        
        .d-remark { font-size: 13px; color: #666; background: #fff8e1; padding: 10px; border-radius: 8px; line-height: 1.5; margin-bottom: 20px; border-left: 3px solid #ffc107;}

        .d-actions { padding: 15px 20px; border-top: 1px solid #f0f0f0; display: flex; gap: 10px; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .btn-full { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 600; font-size: 15px; display: flex; justify-content: center; align-items: center; gap: 5px; cursor: pointer;}
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 159, 67, 0.25); }
        .btn-default { background: #f1f2f6; color: #666; }

        /* å½•å…¥å¼¹çª— */
        #add-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 3000;
            padding: 20px; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column;
        }
        #add-modal.open { transform: translateY(0); }
        .input-group { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .input-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .input-row:last-child { border-bottom: none; }
        .input-row label { width: 70px; font-size: 14px; color: #666; }
        .input-row input { flex: 1; border: none; outline: none; font-size: 15px; text-align: right; }
        
        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .chip { padding: 5px 12px; background: #f5f5f5; border-radius: 15px; font-size: 12px; color: #666; border: 1px solid transparent; }
        .chip.active { background: #FFF4E6; color: var(--primary); border-color: var(--primary); }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 56px; height: 56px; background: var(--primary); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; color: white;
            font-size: 24px; box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4);
            z-index: 1500; border: none; transition: 0.2s; cursor: pointer;
        }
        .fab:active { transform: translateX(-50%) scale(0.95); }
    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fas fa-paw"></i> æµæµªå’ª</div>
        <div class="view-toggle">
            <button class="toggle-btn active" onclick="switchView('map')">åœ°å›¾</button>
            <button class="toggle-btn" onclick="switchView('list')">åˆ—è¡¨</button>
        </div>
    </header>

    <main>
        <div id="map-container"></div>
        <div id="list-container"></div>
    </main>

    <button class="fab" onclick="openAddModal()"><i class="fas fa-plus"></i></button>

    <div class="bottom-sheet" id="detail-sheet">
        <div class="sheet-handle" onclick="closeDetail()"></div>
        <div class="sheet-scroll">
            <div class="d-hero">
                <img id="d-img" class="d-avatar" src="" onerror="onImgError(this)">
                <div class="d-header">
                    <h2 id="d-name">çŒ«å</h2>
                    <span id="d-id" class="d-id">ID: --</span>
                </div>
            </div>

            <div class="d-grid">
                <div class="d-grid-item">
                    <div class="d-label">çŠ¶æ€</div>
                    <div class="d-val" id="d-status" style="color: #009688;">-</div>
                </div>
                <div class="d-grid-item">
                    <div class="d-label">æ€§æ ¼</div>
                    <div class="d-val" id="d-char">-</div>
                </div>
                <div class="d-grid-item">
                    <div class="d-label">å–œå¥½</div>
                    <div class="d-val" id="d-food">-</div>
                </div>
            </div>

            <div class="d-remark" id="d-remark">
                å¤‡æ³¨ä¿¡æ¯åŠ è½½ä¸­...
            </div>
        </div>

        <div class="d-actions">
            <button class="btn-full btn-default" onclick="closeDetail()">å…³é—­</button>
            <button class="btn-full btn-primary" onclick="alert('å³å°†å”¤èµ·å¯¼èˆªApp...')">
                <i class="fas fa-location-arrow"></i> å»å–‚å®ƒ
            </button>
        </div>
    </div>

    <div id="add-modal">
        <h2 style="margin-bottom: 20px; font-size: 20px;">ğŸ“· å‘ç°æ–°çŒ«å’ª</h2>
        
        <div style="height:120px; background:#f0f0f0; border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#999; margin-bottom:15px;">
            <i class="fas fa-camera" style="font-size:24px; margin-bottom:5px;"></i>
            <span style="font-size:12px;">ç‚¹å‡»æ‹ç…§(æ¨¡æ‹Ÿ)</span>
        </div>

        <div class="input-group">
            <div class="input-row">
                <label>åå­—</label>
                <input type="text" id="add-name" placeholder="å–ä¸ªåå­—ï¼Œå¦‚ï¼šå¤§é»„">
            </div>
            <div class="input-row">
                <label>çŠ¶æ€</label>
                <input type="text" id="add-status" value="æµæµªä¸­" readonly>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <label style="font-size:14px; color:#666; margin-bottom:5px; display:block;">é€‰æ‹©æ€§æ ¼æ ‡ç­¾</label>
            <div class="chip-group" id="add-tags">
                <div class="chip" onclick="toggleChip(this)">äº²äºº</div>
                <div class="chip" onclick="toggleChip(this)">æ€•äºº</div>
                <div class="chip" onclick="toggleChip(this)">è´ªåƒ</div>
                <div class="chip" onclick="toggleChip(this)">å‡¶</div>
            </div>
        </div>

        <button class="btn-full btn-primary" onclick="submitCat()">ç¡®è®¤å½•å…¥</button>
        <button class="btn-full btn-default" style="margin-top:10px;" onclick="closeAddModal()">å–æ¶ˆ</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- æ•°æ®é…ç½® ---
        const NAMES = ["å¤§æ©˜", "ç…¤çƒ", "å°ç™½", "èŠ±èŠ±", "å¥¥åˆ©å¥¥", "æ±¤åœ†", "èŠéº»", "é»„æ²¹", "å¸ƒä¸", "å¯ä¹"];
        const CHARS = ["äº²äºº", "é«˜å†·", "èƒ†å°", "è¯å” ", "ç¤¾ç‰›", "è­¦æƒ•"];
        const FOODS = ["å†»å¹²", "ç½å¤´", "é¸¡èƒ¸è‚‰", "çŒ«æ¡", "ä¸æŒ‘é£Ÿ", "åªåƒè‚‰"];
        const STATUS = ["æµæµªä¸­", "å·²ç»è‚²", "æ±‚é¢†å…»", "æœ‰äººå–‚"];
        const REMARKS = ["å¸¸åœ¨åƒåœ¾æ¡¶é™„è¿‘å‡ºæ²¡ï¼Œå–œæ¬¢ç¿»åƒåœ¾", "å–œæ¬¢åœ¨é•¿æ¤…ä¸Šæ™’å¤ªé˜³ï¼Œå¾ˆæ…µæ‡’", "çœ‹è§äººä¼šä¸»åŠ¨è¹­è£¤è„šï¼Œæ±‚æ‘¸æ‘¸", "æ¯”è¾ƒè­¦æƒ•ï¼Œåªèƒ½è¿œè§‚ä¸å¯äºµç©", "å·¦è€³æœ‰å‰ªè€³æ ‡è®°ï¼Œæ˜¯ç»è‚²è¿‡çš„çŒ«", "ç»å¸¸å’Œå¦ä¸€åªé»‘çŒ«å¾…åœ¨ä¸€èµ·"];

        let map;
        let markers = [];
        let catsData = [];
        let userPos = { lat: 31.2304, lng: 121.4737 };

        // --- é˜²è£‚å›¾é€»è¾‘ ---
        function onImgError(img) {
            img.onerror = null;
            const color = ['#FF9F43','#54a0ff','#ff6b6b','#1dd1a1'][Math.floor(Math.random()*4)];
            img.src = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100%" height="100%" fill="${encodeURIComponent(color)}"/><text x="50%" y="55%" font-size="40" fill="white" text-anchor="middle" font-family="Arial" dy=".3em">ğŸ±</text></svg>`;
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    p => { userPos = {lat: p.coords.latitude, lng: p.coords.longitude}; initMap(); },
                    e => { console.log("å®šä½å¤±è´¥"); initMap(); }
                );
            } else { initMap(); }
        }

        function initMap() {
            catsData = generateRandomCats(userPos.lat, userPos.lng);
            
            map = L.map('map-container', {zoomControl: false}).setView([userPos.lat, userPos.lng], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
            
            const meIcon = L.divIcon({className: 'me', html: `<div style="width:16px;height:16px;background:#3498db;border:2px solid #fff;border-radius:50%;box-shadow:0 0 8px #3498db;"></div>`});
            L.marker([userPos.lat, userPos.lng], {icon: meIcon}).addTo(map);

            refreshView();
        }

        function refreshView() {
            renderMarkers();
            renderList();
        }

        function renderMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            catsData.forEach(cat => {
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="cat-marker"><img src="${cat.img}" onerror="onImgError(this)"></div>`,
                    iconSize: [44, 44], iconAnchor: [22, 44]
                });
                
                const m = L.marker([cat.lat, cat.lng], {icon: icon})
                    .addTo(map)
                    .on('click', () => openDetail(cat));
                markers.push(m);
            });
        }

        function renderList() {
            const list = document.getElementById('list-container');
            list.innerHTML = '';
            catsData.forEach(cat => {
                const item = `
                    <div class="cat-card" onclick="openDetailById('${cat.id}')">
                        <img src="${cat.img}" onerror="onImgError(this)">
                        <div class="cat-info">
                            <div class="cat-top">
                                <span class="cat-name">${cat.name}</span>
                                <span class="cat-status">${cat.status}</span>
                            </div>
                            <div class="cat-detail-row">
                                <i class="fas fa-map-marker-alt"></i> ${cat.dist}m | ${cat.char}
                            </div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#ccc; font-size:12px;"></i>
                    </div>`;
                list.innerHTML += item;
            });
        }

        // --- æ ¸å¿ƒæ›´æ–°ï¼šäº¤äº’é€»è¾‘ ---
        function openDetailById(id) {
            const cat = catsData.find(c => c.id === id);
            if(cat) openDetail(cat);
        }

        function openDetail(cat) {
            // 1. å¡«å……ä¿¡æ¯
            document.getElementById('d-img').src = cat.img;
            document.getElementById('d-name').innerText = cat.name;
            document.getElementById('d-id').innerText = `ID: ${cat.id}`;
            document.getElementById('d-status').innerText = cat.status;
            document.getElementById('d-char').innerText = cat.char;
            document.getElementById('d-food').innerText = cat.food;
            document.getElementById('d-remark').innerText = cat.remark;

            // 2. æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœåœ¨åˆ—è¡¨é¡µï¼Œå¼ºåˆ¶åˆ‡å›åœ°å›¾ï¼Œå¹¶é£è¡Œå®šä½
            const mapContainer = document.getElementById('map-container');
            const listContainer = document.getElementById('list-container');
            
            if (listContainer.style.display !== 'none') {
                // å½“å‰æ˜¯åˆ—è¡¨æ¨¡å¼ï¼Œåˆ‡æ¢è§†å›¾
                switchView('map');
            }

            // 3. æ‰§è¡Œåœ°å›¾é£è¡Œå®šä½ (flyTo)
            map.invalidateSize(); // ç¡®ä¿åœ°å›¾æ¸²æŸ“æ­£ç¡®
            map.flyTo([cat.lat, cat.lng], 18, {
                animate: true,
                duration: 1 // é£è¡Œæ—¶é—´1ç§’
            });

            // 4. ç¨å¾®å»¶è¿Ÿå¼¹å‡ºè¯¦æƒ…ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°åœ°å›¾ç§»åŠ¨
            setTimeout(() => {
                document.getElementById('detail-sheet').classList.add('open');
            }, 400); 
        }

        function closeDetail() {
            document.getElementById('detail-sheet').classList.remove('open');
        }

        // --- å½•å…¥é€»è¾‘ ---
        function openAddModal() {
            document.getElementById('add-modal').classList.add('open');
            document.getElementById('add-name').value = '';
        }
        function closeAddModal() { document.getElementById('add-modal').classList.remove('open'); }
        function toggleChip(el) { el.classList.toggle('active'); }

        function submitCat() {
            const name = document.getElementById('add-name').value || "æ— åçŒ«";
            const chips = document.querySelectorAll('.chip.active');
            const char = chips.length > 0 ? chips[0].innerText : "æœªçŸ¥";
            
            const center = map.getCenter();
            const newCat = {
                id: Math.floor(Math.random()*9000+1000),
                lat: center.lat, lng: center.lng,
                name: name,
                status: "æ–°å‘ç°",
                char: char,
                food: "æœªçŸ¥",
                remark: "æ–°å½•å…¥çš„çŒ«å’ªï¼Œç­‰å¾…å®Œå–„ä¿¡æ¯ã€‚",
                img: "invalid_url_trigger_backup",
                dist: 0
            };
            
            catsData.unshift(newCat);
            refreshView();
            closeAddModal();
            
            // å½•å…¥åä¹Ÿè‡ªåŠ¨é£è¡Œå®šä½å¹¶æ˜¾ç¤ºè¯¦æƒ…
            openDetail(newCat);
        }

        // --- å·¥å…·å‡½æ•° ---
        function generateRandomCats(lat, lng) {
            let res = [];
            for(let i=0; i<15; i++) {
                const rLat = lat + (Math.random()-0.5)*0.006;
                const rLng = lng + (Math.random()-0.5)*0.006;
                res.push({
                    id: 8000+i,
                    lat: rLat, lng: rLng,
                    name: NAMES[Math.floor(Math.random()*NAMES.length)],
                    status: STATUS[Math.floor(Math.random()*STATUS.length)],
                    char: CHARS[Math.floor(Math.random()*CHARS.length)],
                    food: FOODS[Math.floor(Math.random()*FOODS.length)],
                    remark: REMARKS[Math.floor(Math.random()*REMARKS.length)],
                    img: `https://loremflickr.com/200/200/cat?lock=${i}`,
                    dist: Math.floor(Math.random()*600)
                });
            }
            return res;
        }

        function switchView(mode) {
            const m = document.getElementById('map-container');
            const l = document.getElementById('list-container');
            const btns = document.querySelectorAll('.toggle-btn');
            const fab = document.querySelector('.fab');
            
            if(mode === 'map') {
                m.style.display='block'; l.style.display='none';
                btns[0].classList.add('active'); btns[1].classList.remove('active');
                fab.style.display = 'flex';
                setTimeout(()=>map.invalidateSize(), 100);
            } else {
                m.style.display='none'; l.style.display='block';
                btns[0].classList.remove('active'); btns[1].classList.add('active');
                fab.style.display = 'none';
            }
        }
    </script>
</body>
</html>
