<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å…¨èƒ½å·¥å…·ç®± - æŒ‰é’®ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .page-card { transition: all 0.2s; cursor: grab; position: relative; }
        .page-card:active { cursor: grabbing; }
        .page-card.dragging { opacity: 0.4; border: 2px dashed #3b82f6; }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .page-card.selected { ring: 2px solid #3b82f6; background-color: #eff6ff; }
        .page-card.selected .check-indicator { display: flex; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .preset-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-gray-700">

    <div class="max-w-6xl mx-auto py-8 px-4">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">PDF æœ¬åœ°å·¥å…·ç®±</h1>
            <p class="text-sm text-gray-500">ç¦»çº¿å¤„ç† Â· æ•°æ®å®‰å…¨ Â· çº¯æµè§ˆå™¨è¿è¡Œ</p>
        </div>

        <div class="flex justify-center mb-6">
            <div class="bg-white p-1 rounded-lg shadow-sm inline-flex border border-gray-200 overflow-hidden">
                <button onclick="switchTab('compress')" id="tab-compress" class="tab-btn px-4 sm:px-6 py-2 rounded-md text-sm font-medium transition-all">å‹ç¼©ç˜¦èº«</button>
                <button onclick="switchTab('merge')" id="tab-merge" class="tab-btn px-4 sm:px-6 py-2 rounded-md text-sm font-medium transition-all">å¤šæ–‡ä»¶åˆå¹¶</button>
                <button onclick="switchTab('editor')" id="tab-editor" class="tab-btn px-4 sm:px-6 py-2 rounded-md text-sm font-medium transition-all">æ’åº/æ—‹è½¬/åˆ é™¤</button>
            </div>
        </div>

        <div id="view-compress" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div class="max-w-xl mx-auto">
                <div id="comp-drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-gray-50 transition-all">
                    <input type="file" id="comp-file-input" accept="application/pdf" class="hidden">
                    <div class="space-y-2">
                        <div class="text-4xl">ğŸ—œï¸</div>
                        <p class="text-lg font-medium">ç‚¹å‡»ä¸Šä¼  PDF (å‹ç¼©)</p>
                        <p class="text-xs text-gray-400" id="comp-file-name">é€šè¿‡å›¾ç‰‡åŒ–é™ä½ä½“ç§¯</p>
                    </div>
                </div>

                <div id="comp-settings" class="mt-6 hidden space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">å¿«é€Ÿé€‰æ‹©å‹ç¼©æ¨¡å¼ï¼š</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="applyPreset(0.9, 1.9, this)" class="preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300 transition-all">
                                <div class="font-bold text-sm text-gray-800">è½»åº¦å‹ç¼©</div>
                                <div class="text-xs text-gray-400 mt-1">ç”»è´¨ä¼˜å…ˆ</div>
                            </button>
                            <button onclick="applyPreset(0.8, 1.8, this)" class="preset-btn active border border-blue-500 bg-blue-50 text-blue-600 rounded-lg p-3 text-center transition-all">
                                <div class="font-bold text-sm">æ¨èå‹ç¼©</div>
                                <div class="text-xs opacity-75 mt-1">å‡è¡¡æ¨¡å¼</div>
                            </button>
                            <button onclick="applyPreset(0.7, 1.6, this)" class="preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300 transition-all">
                                <div class="font-bold text-sm text-gray-800">å¼ºåŠ›ç˜¦èº«</div>
                                <div class="text-xs text-gray-400 mt-1">æé™ä½“ç§¯</div>
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 grid grid-cols-2 gap-6">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-500">å›¾ç‰‡è´¨é‡</label>
                                <span id="q-val" class="text-xs font-bold text-blue-600">0.8</span>
                            </div>
                            <input type="range" id="quality" min="0.1" max="1.0" step="0.1" value="0.8" class="w-full accent-blue-600" oninput="updateVal('q', this.value)">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-xs font-bold text-gray-500">ç¼©æ”¾æ¯”ä¾‹</label>
                                <span id="s-val" class="text-xs font-bold text-blue-600">1.8x</span>
                            </div>
                            <input type="range" id="scale" min="0.5" max="2.0" step="0.1" value="1.8" class="w-full accent-blue-600" oninput="updateVal('s', this.value)">
                        </div>
                    </div>
                    <button id="btn-start-compress" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition-all">å¼€å§‹å‹ç¼©</button>
                </div>
                
                <div id="comp-result" class="hidden mt-6 text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <p id="comp-status" class="mb-2 text-sm text-gray-600">å¤„ç†ä¸­...</p>
                    <div id="comp-actions" class="hidden space-y-3">
                        <a id="comp-download" class="inline-block w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold shadow-md transition-all">ä¸‹è½½å‹ç¼©æ–‡ä»¶</a>
                        <button onclick="resetCompress()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 px-6 py-2 rounded-lg text-sm font-medium transition-all">å‹ç¼©ä¸‹ä¸€ä¸ªæ–‡ä»¶</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-merge" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div class="max-w-2xl mx-auto">
                <div class="flex justify-between items-center mb-4 gap-2">
                    <h3 class="font-bold">åˆå¹¶åˆ—è¡¨</h3>
                    <div class="flex gap-2">
                        <button onclick="clearMergeList()" class="text-red-500 text-sm font-bold border border-red-200 px-3 py-1 rounded bg-red-50 hover:bg-red-100">æ¸…ç©ºåˆ—è¡¨</button>
                        <button onclick="document.getElementById('merge-input').click()" class="text-blue-600 text-sm font-bold border border-blue-200 px-3 py-1 rounded bg-blue-50 hover:bg-blue-100">+ æ·»åŠ æ–‡ä»¶</button>
                    </div>
                    <input type="file" id="merge-input" accept="application/pdf" multiple class="hidden">
                </div>
                <ul id="merge-list" class="space-y-2 min-h-[100px] border-2 border-dashed border-gray-100 rounded-lg p-4 mb-4">
                    <li class="text-center text-gray-400 text-sm py-4">æš‚æ— æ–‡ä»¶ï¼Œè¯·æ·»åŠ </li>
                </ul>
                <button id="btn-start-merge" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg hidden shadow-md">åˆå¹¶å¹¶ä¸‹è½½</button>
            </div>
        </div>

        <div id="view-editor" class="view-section bg-white rounded-xl shadow-lg p-6 border border-gray-100 hidden">
            <div id="edit-upload-area" class="max-w-xl mx-auto border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:border-purple-400 hover:bg-gray-50 transition-all">
                <input type="file" id="edit-file-input" accept="application/pdf" class="hidden">
                <div class="text-4xl mb-2">ğŸ“„</div>
                <p class="text-lg font-medium text-gray-700">ç‚¹å‡»ä¸Šä¼  PDF (é¡µé¢ç¼–è¾‘)</p>
                <p class="text-xs text-gray-400">æ”¯æŒæ’åºã€æ—‹è½¬ã€åˆ é™¤é¡µé¢</p>
            </div>

            <div id="edit-work-area" class="hidden">
                <div class="sticky top-0 bg-white z-20 py-3 border-b shadow-sm mb-4">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <button onclick="resetEditor()" class="text-gray-500 hover:text-gray-700 text-sm flex items-center gap-1 border border-gray-300 rounded px-2 py-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                é‡ä¼ 
                            </button>
                            <span class="text-gray-400">|</span>
                            <div class="flex gap-2">
                                <button onclick="toggleSelectAll()" id="btn-select-all" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 font-medium">å…¨é€‰</button>
                                <button onclick="rotateSelected(-90)" class="text-sm px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                    é€‰ä¸­å·¦æ—‹
                                </button>
                                <button onclick="rotateSelected(90)" class="text-sm px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded font-medium flex items-center gap-1">
                                    é€‰ä¸­å³æ—‹
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path></svg>
                                </button>
                            </div>
                        </div>
                        <button id="btn-save-order" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-2 rounded-lg shadow-md transition-colors flex items-center gap-2 text-sm">
                            <span>ä¿å­˜ PDF</span>
                        </button>
                    </div>
                </div>

                <div id="pages-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-2 bg-gray-50 rounded-lg min-h-[400px]">
                    </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.className = 'tab-btn px-4 sm:px-6 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            const colors = { 'compress': 'blue', 'merge': 'indigo', 'editor': 'purple' };
            activeBtn.className = `tab-btn px-4 sm:px-6 py-2 rounded-md text-sm font-medium transition-all bg-${colors[tabName]}-100 text-${colors[tabName]}-700 shadow-sm`;
        }
        switchTab('compress');

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ================= 1. å‹ç¼©é€»è¾‘ =================
        const compInput = document.getElementById('comp-file-input');
        let compFile = null;
        
        window.applyPreset = (q, s, btn) => {
            document.getElementById('quality').value = q;
            document.getElementById('scale').value = s;
            updateVal('q', q);
            updateVal('s', s);
            document.querySelectorAll('.preset-btn').forEach(b => {
                b.className = 'preset-btn border border-gray-200 rounded-lg p-3 text-center hover:border-blue-300 transition-all';
                b.querySelector('.font-bold').className = 'font-bold text-sm text-gray-800';
                b.querySelector('.text-xs').className = 'text-xs text-gray-400 mt-1';
            });
            btn.className = 'preset-btn active border border-blue-500 bg-blue-50 text-blue-600 rounded-lg p-3 text-center transition-all';
            btn.querySelector('.font-bold').className = 'font-bold text-sm';
            btn.querySelector('.text-xs').className = 'text-xs opacity-75 mt-1';
        };

        window.updateVal = (type, val) => {
            if(type === 'q') document.getElementById('q-val').innerText = val;
            if(type === 's') document.getElementById('s-val').innerText = val + 'x';
        };

        window.resetCompress = () => {
            compFile = null; compInput.value = '';
            document.getElementById('comp-drop-zone').classList.remove('hidden');
            document.getElementById('comp-settings').classList.add('hidden');
            document.getElementById('comp-result').classList.add('hidden');
            document.getElementById('comp-actions').classList.add('hidden');
            document.querySelector('#comp-result .spinner').classList.remove('hidden');
        };

        document.getElementById('comp-drop-zone').onclick = () => compInput.click();
        compInput.onchange = (e) => {
            if(e.target.files[0]) {
                if(!document.getElementById('comp-result').classList.contains('hidden')) resetCompress();
                compFile = e.target.files[0];
                document.getElementById('comp-drop-zone').classList.add('hidden');
                document.getElementById('comp-file-name').innerText = compFile.name + ` (${formatBytes(compFile.size)})`;
                document.getElementById('comp-settings').classList.remove('hidden');
            }
        };

        document.getElementById('btn-start-compress').onclick = async () => {
            if(!compFile) return;
            const status = document.getElementById('comp-status');
            const downloadArea = document.getElementById('comp-actions');
            const link = document.getElementById('comp-download');
            const spinner = document.querySelector('#comp-result .spinner');
            
            document.getElementById('comp-result').classList.remove('hidden');
            document.getElementById('comp-settings').classList.add('hidden');
            spinner.classList.remove('hidden');
            downloadArea.classList.add('hidden');
            
            try {
                const arrayBuffer = await compFile.arrayBuffer();
                const pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const newPdf = await PDFLib.PDFDocument.create();
                const q = parseFloat(document.getElementById('quality').value);
                const s = parseFloat(document.getElementById('scale').value);

                for(let i=1; i<=pdfDoc.numPages; i++) {
                    status.innerText = `æ­£åœ¨å¤„ç†é¡µé¢: ${i} / ${pdfDoc.numPages}`;
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({scale: s});
                    const cvs = document.createElement('canvas');
                    cvs.width = viewport.width; cvs.height = viewport.height;
                    await page.render({canvasContext: cvs.getContext('2d'), viewport}).promise;
                    const img = await newPdf.embedJpg(cvs.toDataURL('image/jpeg', q));
                    newPdf.addPage([viewport.width, viewport.height]).drawImage(img, {x:0, y:0, width:viewport.width, height:viewport.height});
                }
                status.innerText = "æ­£åœ¨æ‰“åŒ…ç”Ÿæˆ...";
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], {type: 'application/pdf'});
                
                spinner.classList.add('hidden');
                link.href = URL.createObjectURL(blob);
                link.download = 'compressed_' + compFile.name;
                downloadArea.classList.remove('hidden');
                const reduction = ((compFile.size - blob.size) / compFile.size * 100).toFixed(1);
                const sizeText = blob.size > compFile.size ? `âš ï¸ æ–‡ä»¶å˜å¤§äº†` : `âœ… ç˜¦èº« ${reduction}%`;
                status.innerHTML = `<span class="font-bold text-gray-800">å®Œæˆ!</span> <span class="text-xs text-gray-500">${formatBytes(compFile.size)} â ${formatBytes(blob.size)}</span> <br><span class="text-sm ${blob.size > compFile.size ? 'text-red-500' : 'text-green-600'} font-bold">${sizeText}</span>`;
            } catch(e) { alert('é”™è¯¯: ' + e.message); resetCompress(); }
        };

        // ================= 2. åˆå¹¶é€»è¾‘ =================
        let mergeFiles = [];
        const mergeInput = document.getElementById('merge-input');
        const mergeList = document.getElementById('merge-list');
        const btnMerge = document.getElementById('btn-start-merge');

        window.clearMergeList = () => { mergeFiles = []; renderMergeList(); mergeInput.value = ''; };
        mergeInput.onchange = (e) => { mergeFiles = [...mergeFiles, ...Array.from(e.target.files)]; renderMergeList(); btnMerge.classList.remove('hidden'); mergeInput.value = ''; };

        function renderMergeList() {
            if(mergeFiles.length === 0) { mergeList.innerHTML = '<li class="text-center text-gray-400 text-sm py-4">æš‚æ— æ–‡ä»¶ï¼Œè¯·æ·»åŠ </li>'; btnMerge.classList.add('hidden'); return; }
            mergeList.innerHTML = mergeFiles.map((f, i) => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded border">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="bg-gray-200 text-xs font-bold px-2 py-1 rounded text-gray-600">${i+1}</span>
                        <span class="truncate text-sm w-40 sm:w-64" title="${f.name}">${f.name}</span>
                    </div>
                    <div class="flex items-center gap-1 shrink-0">
                        <button onclick="moveMerge(${i}, -1)" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded" ${i === 0 ? 'disabled style="opacity:0.3"' : ''}>â†‘</button>
                        <button onclick="moveMerge(${i}, 1)" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded" ${i === mergeFiles.length - 1 ? 'disabled style="opacity:0.3"' : ''}>â†“</button>
                        <button onclick="removeMerge(${i})" class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded ml-1">Ã—</button>
                    </div>
                </li>
            `).join('');
        }
        window.moveMerge = (index, direction) => {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= mergeFiles.length) return;
            [mergeFiles[index], mergeFiles[newIndex]] = [mergeFiles[newIndex], mergeFiles[index]];
            renderMergeList();
        };
        window.removeMerge = (i) => { mergeFiles.splice(i, 1); renderMergeList(); };
        btnMerge.onclick = async () => {
            const btn = document.getElementById('btn-start-merge'); btn.innerText = 'æ­£åœ¨åˆå¹¶...'; btn.disabled = true;
            try {
                const newPdf = await PDFLib.PDFDocument.create();
                for(let f of mergeFiles) {
                    const pdf = await PDFLib.PDFDocument.load(await f.arrayBuffer());
                    (await newPdf.copyPages(pdf, pdf.getPageIndices())).forEach(p => newPdf.addPage(p));
                }
                const blob = new Blob([await newPdf.save()], {type: 'application/pdf'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'merged.pdf'; a.click();
            } catch (e) { alert('åˆå¹¶å¤±è´¥: ' + e.message); } finally { btn.innerText = 'åˆå¹¶å¹¶ä¸‹è½½'; btn.disabled = false; }
        };

        // ================= 3. ç¼–è¾‘/æ—‹è½¬é€»è¾‘ (UI é‡æ„ç‰ˆ) =================
        const editInput = document.getElementById('edit-file-input');
        const editZone = document.getElementById('edit-upload-area');
        const editWorkArea = document.getElementById('edit-work-area');
        const grid = document.getElementById('pages-grid');
        let currentEditFile = null; 

        window.resetEditor = () => {
            currentEditFile = null;
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">æ­£åœ¨ç”Ÿæˆé¡µé¢ç¼©ç•¥å›¾...</div>';
            editWorkArea.classList.add('hidden');
            editZone.classList.remove('hidden');
            editInput.value = '';
        };

        editZone.onclick = () => editInput.click();
        
        editInput.onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            currentEditFile = file; 
            editZone.classList.add('hidden');
            editWorkArea.classList.remove('hidden');
            
            const buffer = await file.arrayBuffer();
            const pdfDoc = await pdfjsLib.getDocument({data: buffer}).promise;
            
            grid.innerHTML = ''; 
            for(let i=1; i<=pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({scale: 0.25}); 
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;

                const card = document.createElement('div');
                card.className = "page-card bg-white border border-gray-200 shadow-sm rounded-lg p-2 flex flex-col items-center select-none group relative";
                card.draggable = true;
                card.dataset.pageIndex = i - 1; 
                card.dataset.rotation = 0;

                // ä¿®æ”¹äº†è¿™é‡Œï¼šæŒ‰é’®åŒºåŸŸå•ç‹¬æˆè¡Œï¼Œä¸å†éšè—
                card.innerHTML = `
                    <div class="check-indicator absolute top-2 right-2 bg-blue-600 text-white rounded-full p-0.5 hidden z-10 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <div class="relative w-full h-40 flex items-center justify-center bg-gray-100 mb-2 overflow-hidden rounded cursor-pointer" onclick="toggleSelect(this)">
                        <img src="${canvas.toDataURL()}" class="max-w-full max-h-full object-contain pointer-events-none transition-transform duration-200" style="transform: rotate(0deg)">
                    </div>
                    
                    <div class="w-full">
                        <div class="text-center text-xs font-bold text-gray-500 mb-2">ç¬¬ ${i} é¡µ</div>
                        <div class="flex justify-between gap-1 w-full">
                             <button onclick="rotateCard(this, -90)" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 py-1 rounded text-xs border border-blue-100 font-medium">â†º å·¦æ—‹</button>
                             <button onclick="rotateCard(this, 90)" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 py-1 rounded text-xs border border-blue-100 font-medium">â†» å³æ—‹</button>
                             <button onclick="this.closest('.page-card').remove()" class="px-2 bg-red-50 hover:bg-red-100 text-red-500 rounded border border-red-100" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
                addDnDEvents(card);
                grid.appendChild(card);
            }
        };

        window.rotateCard = (btn, deg) => {
            const card = btn.closest('.page-card');
            const img = card.querySelector('img');
            let currentRotation = parseInt(card.dataset.rotation) || 0;
            currentRotation += deg;
            card.dataset.rotation = currentRotation;
            img.style.transform = `rotate(${currentRotation}deg)`;
        };

        window.toggleSelect = (div) => {
            const card = div.closest('.page-card');
            card.classList.toggle('selected');
        };

        window.toggleSelectAll = () => {
            const cards = document.querySelectorAll('.page-card');
            const allSelected = Array.from(cards).every(c => c.classList.contains('selected'));
            cards.forEach(c => {
                if(allSelected) c.classList.remove('selected');
                else c.classList.add('selected');
            });
            document.getElementById('btn-select-all').innerText = allSelected ? 'å…¨é€‰' : 'å–æ¶ˆå…¨é€‰';
        };

        window.rotateSelected = (deg) => {
            const selectedCards = document.querySelectorAll('.page-card.selected');
            if(selectedCards.length === 0) return alert('è¯·å…ˆç‚¹å‡»å›¾ç‰‡é€‰ä¸­è¦æ—‹è½¬çš„é¡µé¢');
            selectedCards.forEach(card => {
                const img = card.querySelector('img');
                let currentRotation = parseInt(card.dataset.rotation) || 0;
                currentRotation += deg;
                card.dataset.rotation = currentRotation;
                img.style.transform = `rotate(${currentRotation}deg)`;
            });
        };

        let dragSrcEl = null;
        function addDnDEvents(item) {
            item.addEventListener('dragstart', function(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); });
            item.addEventListener('dragend', function(e) { this.classList.remove('dragging'); });
            item.addEventListener('dragover', function(e) { if(e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
            item.addEventListener('drop', function(e) {
                if(e.stopPropagation) e.stopPropagation();
                if(dragSrcEl !== this) {
                    const allCards = [...grid.children];
                    const srcIndex = allCards.indexOf(dragSrcEl);
                    const targetIndex = allCards.indexOf(this);
                    if(srcIndex < targetIndex) grid.insertBefore(dragSrcEl, this.nextSibling);
                    else grid.insertBefore(dragSrcEl, this);
                }
                return false;
            });
        }

        document.getElementById('btn-save-order').onclick = async () => {
            if (!currentEditFile) return;
            const btn = document.getElementById('btn-save-order');
            btn.innerHTML = '<span>â³ å¤„ç†ä¸­...</span>';
            try {
                const freshBuffer = await currentEditFile.arrayBuffer();
                const srcDoc = await PDFLib.PDFDocument.load(freshBuffer);
                const newDoc = await PDFLib.PDFDocument.create();
                const cards = document.querySelectorAll('#pages-grid .page-card');
                
                if (cards.length === 0) { alert("è¯·è‡³å°‘ä¿ç•™ä¸€é¡µï¼"); return; }

                for (const card of cards) {
                    const pageIndex = parseInt(card.dataset.pageIndex);
                    const rotation = parseInt(card.dataset.rotation) || 0;
                    const [page] = await newDoc.copyPages(srcDoc, [pageIndex]);
                    const existingRotation = page.getRotation().angle;
                    page.setRotation(PDFLib.degrees(existingRotation + rotation));
                    newDoc.addPage(page);
                }
                const blob = new Blob([await newDoc.save()], { type: 'application/pdf' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'edited_pdf.pdf'; a.click();
            } catch(e) { console.error(e); alert("ä¿å­˜å¤±è´¥: " + e.message); } finally { btn.innerHTML = '<span>ä¿å­˜ PDF</span>'; }
        };
    </script>
</body>
</html>
