<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é˜´å®…é£æ°´é€Ÿè¯„å·¥å…·ï¼ˆæ°‘ä¿—å‚è€ƒï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --card:#101f3f;
      --muted:#9fb1d1;
      --text:#e9f0ff;
      --line:rgba(255,255,255,.12);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(124,58,237,.28), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
                  linear-gradient(180deg, #070b14 0%, #0b1220 45%, #081024 100%);
      color:var(--text);
    }
    .wrap{
      max-width: 1120px;
      margin: 28px auto 48px;
      padding: 0 16px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom: 14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    h1{
      font-size: 22px;
      margin:0;
      letter-spacing:.4px;
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
      line-height:1.5;
      max-width: 860px;
    }
    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      user-select:none;
    }
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(124,58,237,.45));
      border-color: rgba(124,58,237,.65);
    }
    .btn.primary:hover{ background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.55)); }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:start;
      margin-top: 14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; }
      .top-actions{ justify-content:flex-start; }
    }
    .panel{
      background: rgba(16,31,63,.55);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .panel-hd h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.3px;
    }
    .panel-hd .hint{
      color: var(--muted);
      font-size: 12px;
    }
    .panel-bd{
      padding: 14px 16px 16px;
    }
    .section{
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      padding: 12px;
      margin-bottom: 12px;
    }
    .section:last-child{ margin-bottom: 0; }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-title strong{
      font-size: 13px;
      letter-spacing:.2px;
    }
    .section-title span{
      font-size: 12px;
      color: var(--muted);
    }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
    }
    @media (max-width: 620px){
      .form{ grid-template-columns: 1fr; }
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      transition: border-color .2s ease, background .2s ease;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,58,237,.65);
      background: rgba(255,255,255,.08);
    }
    .row{
      grid-column: 1 / -1;
    }
    .radio-group, .check-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:2px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
    }
    .pill:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.07); }
    .pill input{ accent-color: var(--accent); }
    .footer-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .disclaimer{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
      padding: 10px 12px;
      border-left: 3px solid rgba(124,58,237,.8);
      background: rgba(124,58,237,.08);
      border-radius: 12px;
      margin-top: 12px;
    }
    /* Results */
    .score-box{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .kpi{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:space-between;
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .kpi .left{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .label{
      font-size: 12px;
      color: var(--muted);
    }
    .kpi .value{
      font-size: 22px;
      letter-spacing:.5px;
      font-weight: 700;
    }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.good{ border-color: rgba(16,185,129,.55); background: rgba(16,185,129,.10); }
    .tag.mid{ border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.10); }
    .tag.bad{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.10); }
    .bar{
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(245,158,11,.9), rgba(34,197,94,.9));
      transition: width .45s ease;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      padding: 12px;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .list{
      margin:0;
      padding-left: 18px;
      color: var(--text);
      line-height: 1.6;
      font-size: 13px;
    }
    .list li{ margin: 6px 0; }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(233,240,255,.88);
      background: rgba(255,255,255,.06);
      border: 1px dashed rgba(255,255,255,.18);
      padding: 10px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){
      .split{ grid-template-columns: 1fr; }
    }
    .muted{ color: var(--muted); }
    .small{ font-size: 12px; }
    .hr{
      height:1px; background: var(--line); margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1 data-i18n="appTitle">é˜´å®…é£æ°´é€Ÿè¯„å·¥å…·ï¼ˆæ°‘ä¿—å‚è€ƒï¼‰</h1>
        <div class="sub" data-i18n="appSub">
          è¿™ä¸æ˜¯ç§‘å­¦ç»“è®ºï¼Œä»…æŒ‰ä¼ ç»Ÿè¦ç´ ï¼ˆåœ°åŠ¿/æ°´/ç ‚/å‘/è·¯/é£/å‘¨è¾¹ï¼‰åšä¸€ä¸ªâ€œå¯è§£é‡Šâ€çš„è¯„åˆ†ä¸å»ºè®®ï¼Œç”¨æ¥è¾…åŠ©æ²Ÿé€šä¸å¯¹æ¯”é€‰å€ã€‚
        </div>
      </div>

      <div class="top-actions">
        <div class="chip" title="Language / è¯­è¨€">
          <span>ğŸŒ</span>
          <select id="langSel" style="padding:6px 10px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)">
            <option value="zh">ä¸­æ–‡</option>
            <option value="en">English</option>
          </select>
        </div>
        <button class="btn" id="btnDemo" type="button">âœ¨ Demo</button>
        <button class="btn" id="btnReset" type="button">â†© é‡ç½®</button>
        <button class="btn primary" id="btnCalc" type="button">ğŸ“ ç”Ÿæˆé£æ°´æŠ¥å‘Š</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div class="panel">
        <div class="panel-hd">
          <h2 data-i18n="inputTitle">è¾“å…¥ä¿¡æ¯</h2>
          <div class="hint" data-i18n="inputHint">å°½é‡æŒ‰â€œå®é™…æƒ…å†µâ€é€‰æ‹©ï¼›ä¸ç¡®å®šå°±é€‰â€œæœªçŸ¥â€ã€‚</div>
        </div>

        <div class="panel-bd">
          <div class="section">
            <div class="section-title">
              <strong data-i18n="secBasic">åŸºç¡€ä¿¡æ¯</strong>
              <span data-i18n="secBasicHint">ç”¨äºæŠ¥å‘ŠæŠ¬å¤´/å¤‡æ³¨</span>
            </div>
            <div class="form">
              <label>
                <span data-i18n="siteName">åœ°ç‚¹åç§°ï¼ˆå¯é€‰ï¼‰</span>
                <input type="text" id="siteName" placeholder="ä¾‹å¦‚ï¼šNew Cairo Cemetery" />
              </label>
              <label>
                <span data-i18n="regionType">åŒºåŸŸç±»å‹</span>
                <select id="regionType">
                  <option value="urban" data-i18n="optUrban">åŸå¸‚/è¿‘éƒŠ</option>
                  <option value="desert" data-i18n="optDesert">æ²™æ¼ /æˆˆå£</option>
                  <option value="mountain" data-i18n="optMountain">å±±åœ°</option>
                  <option value="rural" data-i18n="optRural">ä¹¡é‡/å†œç”°</option>
                  <option value="coastal" data-i18n="optCoastal">æ²¿æµ·</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="purpose">ç”¨é€”</span>
                <select id="purpose">
                  <option value="yinzhai" data-i18n="optYin">é˜´å®…ï¼ˆå¢“åœ°/é™µå›­ï¼‰</option>
                  <option value="yangzhai" data-i18n="optYang">é˜³å®…ï¼ˆä½å®…/å•†é“ºï¼‰</option>
                </select>
              </label>

              <label>
                <span data-i18n="climate">æ°”å€™/é£æ²™</span>
                <select id="climate">
                  <option value="calm" data-i18n="optCalm">é£å°/æ¹¿æ¶¦</option>
                  <option value="normal" data-i18n="optNormal">ä¸€èˆ¬</option>
                  <option value="windy" data-i18n="optWindy">é£å¤§/é£æ²™</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label class="row">
                <span data-i18n="notes">è¡¥å……å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
                <textarea id="notes" placeholder="æ¯”å¦‚ï¼šè·ç¦»é«˜é€Ÿå¾ˆè¿‘ã€å‘¨è¾¹å¾ˆè’ã€è·¯æ˜¯ç›´çš„ã€æ²¡æœ‰æ°´ç³»ã€è§„åˆ’å¢“åŒºç­‰"></textarea>
              </label>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <strong data-i18n="secLand">åœ°åŠ¿ä¸â€œé /æŠ±â€</strong>
              <span data-i18n="secLandHint">ä¼ ç»Ÿï¼šèƒŒæœ‰é ã€å‰æœ‰æ¡ˆã€å·¦å³æœ‰æŠ¤</span>
            </div>
            <div class="form">
              <label>
                <span data-i18n="backing">åé ï¼ˆé å±±/é«˜åœ°/å»ºç­‘å±éšœï¼‰</span>
                <select id="backing">
                  <option value="strong" data-i18n="optStrong">å¼ºï¼ˆæ˜æ˜¾é å±±/é«˜åœ°ï¼‰</option>
                  <option value="some" data-i18n="optSome">æœ‰ä¸€ç‚¹ï¼ˆç¼“å¡/è¿œå±±/å»ºç­‘ç¾¤ï¼‰</option>
                  <option value="flat" data-i18n="optFlat">æ— ï¼ˆå¹³å¦/ç©ºæ—·ï¼‰</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="embrace">ç¯æŠ±ï¼ˆå·¦å³æŠ¤ç ‚/åœ°å½¢åŒ…å›´ï¼‰</span>
                <select id="embrace">
                  <option value="good" data-i18n="optGood">æœ‰ç¯æŠ±ï¼ˆå·¦å³æŠ¤ï¼‰</option>
                  <option value="ok" data-i18n="optOk">ä¸€èˆ¬ï¼ˆéƒ¨åˆ†æŠ¤ï¼‰</option>
                  <option value="open" data-i18n="optOpen">è¿‡äºå¼€é˜”ï¼ˆä¸èšï¼‰</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="slope">å¡åº¦</span>
                <select id="slope">
                  <option value="gentle" data-i18n="optGentle">å¾®å¡/ç¼“å¡ï¼ˆä¼˜ï¼‰</option>
                  <option value="flat" data-i18n="optFlat">å¹³åœ°</option>
                  <option value="steep" data-i18n="optSteep">é™¡å¡ï¼ˆä¸ç¨³ï¼‰</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="ground">åœŸè´¨/åœ°æ°”ï¼ˆä¸»è§‚æ„Ÿå—ï¼‰</span>
                <select id="ground">
                  <option value="firm" data-i18n="optFirm">åšå®/ä¸æ¾æ•£</option>
                  <option value="normal" data-i18n="optNormal">ä¸€èˆ¬</option>
                  <option value="loose" data-i18n="optLoose">æ¾æ•£/æ²™åœŸ</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <strong data-i18n="secWater">æ°´ä¸â€œèšæ°”â€</strong>
              <span data-i18n="secWaterHint">ä¼ ç»Ÿï¼šå¾—æ°´ä¸ºä¸Šï¼Œå¿Œç›´æ¥ç›´å»</span>
            </div>
            <div class="form">
              <label>
                <span data-i18n="water">é™„è¿‘æ˜¯å¦æœ‰æ°´ï¼ˆæ²³/æ¹–/æ¹¿åœ°/ç»¿åŒ–æ°´ç³»ï¼‰</span>
                <select id="water">
                  <option value="meander" data-i18n="optMeander">æœ‰ï¼ˆå¼¯ç¯/å¯èšï¼‰</option>
                  <option value="straight" data-i18n="optStraight">æœ‰ï¼ˆç›´çº¿æ¸ /ç›´å†²ï¼‰</option>
                  <option value="none" data-i18n="optNone">æ— </option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="drainage">æ’æ°´/ç§¯æ°´é£é™©</span>
                <select id="drainage">
                  <option value="good" data-i18n="optGood">è‰¯å¥½</option>
                  <option value="mid" data-i18n="optMid">ä¸€èˆ¬</option>
                  <option value="bad" data-i18n="optBad">å·®/æ˜“ç§¯æ°´</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <strong data-i18n="secRoad">é“è·¯/é«˜é€Ÿ/â€œè·¯å†²â€</strong>
              <span data-i18n="secRoadHint">ä¼ ç»Ÿï¼šç›´å†²ä¸ºç…ï¼›å¼¯æŠ±ä¸ºç¼“</span>
            </div>
            <div class="form">
              <label>
                <span data-i18n="roadNear">æœ€è¿‘ä¸»å¹²é“è·ç¦»</span>
                <select id="roadNear">
                  <option value="veryClose" data-i18n="optVeryClose">å¾ˆè¿‘ï¼ˆ0â€“200mï¼‰</option>
                  <option value="close" data-i18n="optClose">è¾ƒè¿‘ï¼ˆ200â€“800mï¼‰</option>
                  <option value="far" data-i18n="optFar">è¾ƒè¿œï¼ˆ800m+ï¼‰</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="roadShape">é“è·¯å½¢æ€</span>
                <select id="roadShape">
                  <option value="straight" data-i18n="optStraightRoad">ç›´çº¿/é•¿ç›´è·¯</option>
                  <option value="curve" data-i18n="optCurve">å¼¯é“/ç¯æŠ±</option>
                  <option value="grid" data-i18n="optGrid">æ£‹ç›˜è·¯ç½‘</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label class="row">
                <span data-i18n="roadHit">å¢“ä½/å¤§é—¨æ˜¯å¦æ­£å¯¹æ¥è·¯ï¼ˆè·¯å†²ï¼‰</span>
                <div class="radio-group">
                  <label class="pill"><input type="radio" name="roadHit" value="yes"> <span data-i18n="optYes">æ˜¯</span></label>
                  <label class="pill"><input type="radio" name="roadHit" value="no" checked> <span data-i18n="optNo">å¦</span></label>
                  <label class="pill"><input type="radio" name="roadHit" value="unknown"> <span data-i18n="optUnknown">æœªçŸ¥</span></label>
                </div>
              </label>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <strong data-i18n="secFacing">æœå‘/æ—¥ç…§/é€šé£</strong>
              <span data-i18n="secFacingHint">ä¸åŒåœ°åŒº/å®—æ•™å¯èƒ½æœ‰å›ºå®šæœå‘è¦æ±‚</span>
            </div>
            <div class="form">
              <label>
                <span data-i18n="facing">æœå‘ï¼ˆå¤§è‡´ï¼‰</span>
                <select id="facing">
                  <option value="south" data-i18n="optSouth">å—å‘</option>
                  <option value="east" data-i18n="optEast">ä¸œå‘</option>
                  <option value="west" data-i18n="optWest">è¥¿å‘</option>
                  <option value="north" data-i18n="optNorth">åŒ—å‘</option>
                  <option value="fixed" data-i18n="optFixed">æŒ‰å®—æ•™/è§„å®šå›ºå®šæœå‘</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="sun">æ—¥ç…§</span>
                <select id="sun">
                  <option value="good" data-i18n="optGood">å……è¶³</option>
                  <option value="mid" data-i18n="optMid">ä¸€èˆ¬</option>
                  <option value="poor" data-i18n="optPoor">åå·®/é®æŒ¡</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <strong data-i18n="secSurround">å‘¨è¾¹â€œå½¢ç…â€ä¸ç¯å¢ƒ</strong>
              <span data-i18n="secSurroundHint">å™ªéŸ³/å·¥å‚/ç”µå¡”/å°–è§’ç­‰</span>
            </div>
            <div class="form">
              <label class="row">
                <span data-i18n="sha">å‘¨è¾¹æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰</span>
                <div class="check-group" id="shaGroup">
                  <label class="pill"><input type="checkbox" value="pylon"> <span data-i18n="shaPylon">é«˜å‹çº¿/ç”µå¡”</span></label>
                  <label class="pill"><input type="checkbox" value="factory"> <span data-i18n="shaFactory">å·¥å‚/çƒŸå°˜</span></label>
                  <label class="pill"><input type="checkbox" value="noise"> <span data-i18n="shaNoise">å™ªéŸ³ï¼ˆé«˜é€Ÿ/æœºåœºï¼‰</span></label>
                  <label class="pill"><input type="checkbox" value="sharp"> <span data-i18n="shaSharp">å°–è§’/åˆ€åˆƒå½¢å»ºç­‘</span></label>
                  <label class="pill"><input type="checkbox" value="dump"> <span data-i18n="shaDump">åƒåœ¾åœº/æ±¡æ°´</span></label>
                  <label class="pill"><input type="checkbox" value="none"> <span data-i18n="shaNone">æ— æ˜æ˜¾</span></label>
                  <label class="pill"><input type="checkbox" value="unknown"> <span data-i18n="optUnknown">æœªçŸ¥</span></label>
                </div>
              </label>

              <label>
                <span data-i18n="quiet">æ•´ä½“æ¸…é™åº¦</span>
                <select id="quiet">
                  <option value="veryQuiet" data-i18n="optVeryQuiet">å¾ˆæ¸…é™</option>
                  <option value="ok" data-i18n="optOk">ä¸€èˆ¬</option>
                  <option value="noisy" data-i18n="optNoisy">ååµ</option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>

              <label>
                <span data-i18n="green">æ¤è¢«/ç»¿åŒ–</span>
                <select id="green">
                  <option value="good" data-i18n="optGood">æœ‰ç»¿åŒ–/æ ‘</option>
                  <option value="mid" data-i18n="optMid">å°‘é‡</option>
                  <option value="none" data-i18n="optNone">å‡ ä¹æ— </option>
                  <option value="unknown" data-i18n="optUnknown">æœªçŸ¥</option>
                </select>
              </label>
            </div>
          </div>

          <div class="footer-actions">
            <button class="btn primary" id="btnCalc2" type="button">ğŸ“ <span data-i18n="btnGenerate">ç”Ÿæˆé£æ°´æŠ¥å‘Š</span></button>
            <button class="btn" id="btnCopy" type="button">ğŸ“‹ <span data-i18n="btnCopy">å¤åˆ¶æŠ¥å‘Šæ–‡æœ¬</span></button>
            <button class="btn" id="btnSave" type="button">ğŸ’¾ <span data-i18n="btnSave">å¯¼å‡ºJSON</span></button>
          </div>

          <div class="disclaimer" id="disclaimer">
            <strong data-i18n="discTitle">æç¤ºï¼š</strong>
            <span data-i18n="discBody">
              æœ¬å·¥å…·è¾“å‡ºä¸ºä¼ ç»Ÿæ°‘ä¿—è§’åº¦çš„â€œå‚è€ƒæ„è§â€ï¼Œä¸æ„æˆå®—æ•™/æ³•å¾‹/åŒ»å­¦å»ºè®®ã€‚è‹¥æ¶‰åŠå®‰è‘¬ï¼Œè¯·ä¼˜å…ˆéµå¾ªå½“åœ°æ³•å¾‹ã€å®—æ•™è§„èŒƒä¸å®¶å±æ„æ„¿ã€‚
            </span>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTS -->
      <div class="panel">
        <div class="panel-hd">
          <h2 data-i18n="resultTitle">é£æ°´æŠ¥å‘Š</h2>
          <div class="hint" id="reportMeta">â€”</div>
        </div>

        <div class="panel-bd">
          <div class="score-box">
            <div class="kpi">
              <div class="left">
                <div class="label" data-i18n="overallScore">ç»¼åˆè¯„åˆ†ï¼ˆ0â€“100ï¼‰</div>
                <div class="value" id="scoreVal">â€”</div>
                <div class="bar" aria-label="score bar"><i id="scoreBar"></i></div>
              </div>
              <div class="tag mid" id="scoreTag">â€”</div>
            </div>

            <div class="split">
              <div class="card">
                <h3 data-i18n="breakdown">åˆ†é¡¹è§£è¯»</h3>
                <ul class="list" id="breakList"></ul>
              </div>
              <div class="card">
                <h3 data-i18n="recommend">å»ºè®®ä¸é¿å‘</h3>
                <ul class="list" id="advList"></ul>
              </div>
            </div>

            <div class="card">
              <h3 data-i18n="reportText">å®Œæ•´æŠ¥å‘Šï¼ˆå¯å¤åˆ¶ï¼‰</h3>
              <div class="mono" id="reportTextBox">â€”</div>
              <div class="hr"></div>
              <div class="muted small" data-i18n="reportExplain">
                è¯„åˆ†è§„åˆ™ä¸ºâ€œå¯è§£é‡ŠåŠ æƒæ¨¡å‹â€ï¼Œåªåæ˜ ä¼ ç»Ÿè¦ç´ å¼ºå¼±ï¼Œä¸ä»£è¡¨ç°å®ä»·å€¼åˆ¤æ–­ã€‚
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  // ---------------- i18n ----------------
  const I18N = {
    zh: {
      appTitle: "é˜´å®…é£æ°´é€Ÿè¯„å·¥å…·ï¼ˆæ°‘ä¿—å‚è€ƒï¼‰",
      appSub: "è¿™ä¸æ˜¯ç§‘å­¦ç»“è®ºï¼Œä»…æŒ‰ä¼ ç»Ÿè¦ç´ ï¼ˆåœ°åŠ¿/æ°´/ç ‚/å‘/è·¯/é£/å‘¨è¾¹ï¼‰åšä¸€ä¸ªâ€œå¯è§£é‡Šâ€çš„è¯„åˆ†ä¸å»ºè®®ï¼Œç”¨æ¥è¾…åŠ©æ²Ÿé€šä¸å¯¹æ¯”é€‰å€ã€‚",
      inputTitle: "è¾“å…¥ä¿¡æ¯",
      inputHint: "å°½é‡æŒ‰â€œå®é™…æƒ…å†µâ€é€‰æ‹©ï¼›ä¸ç¡®å®šå°±é€‰â€œæœªçŸ¥â€ã€‚",
      secBasic: "åŸºç¡€ä¿¡æ¯",
      secBasicHint: "ç”¨äºæŠ¥å‘ŠæŠ¬å¤´/å¤‡æ³¨",
      siteName: "åœ°ç‚¹åç§°ï¼ˆå¯é€‰ï¼‰",
      regionType: "åŒºåŸŸç±»å‹",
      purpose: "ç”¨é€”",
      climate: "æ°”å€™/é£æ²™",
      notes: "è¡¥å……å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰",
      secLand: "åœ°åŠ¿ä¸â€œé /æŠ±â€",
      secLandHint: "ä¼ ç»Ÿï¼šèƒŒæœ‰é ã€å‰æœ‰æ¡ˆã€å·¦å³æœ‰æŠ¤",
      backing: "åé ï¼ˆé å±±/é«˜åœ°/å»ºç­‘å±éšœï¼‰",
      embrace: "ç¯æŠ±ï¼ˆå·¦å³æŠ¤ç ‚/åœ°å½¢åŒ…å›´ï¼‰",
      slope: "å¡åº¦",
      ground: "åœŸè´¨/åœ°æ°”ï¼ˆä¸»è§‚æ„Ÿå—ï¼‰",
      secWater: "æ°´ä¸â€œèšæ°”â€",
      secWaterHint: "ä¼ ç»Ÿï¼šå¾—æ°´ä¸ºä¸Šï¼Œå¿Œç›´æ¥ç›´å»",
      water: "é™„è¿‘æ˜¯å¦æœ‰æ°´ï¼ˆæ²³/æ¹–/æ¹¿åœ°/ç»¿åŒ–æ°´ç³»ï¼‰",
      drainage: "æ’æ°´/ç§¯æ°´é£é™©",
      secRoad: "é“è·¯/é«˜é€Ÿ/â€œè·¯å†²â€",
      secRoadHint: "ä¼ ç»Ÿï¼šç›´å†²ä¸ºç…ï¼›å¼¯æŠ±ä¸ºç¼“",
      roadNear: "æœ€è¿‘ä¸»å¹²é“è·ç¦»",
      roadShape: "é“è·¯å½¢æ€",
      roadHit: "å¢“ä½/å¤§é—¨æ˜¯å¦æ­£å¯¹æ¥è·¯ï¼ˆè·¯å†²ï¼‰",
      secFacing: "æœå‘/æ—¥ç…§/é€šé£",
      secFacingHint: "ä¸åŒåœ°åŒº/å®—æ•™å¯èƒ½æœ‰å›ºå®šæœå‘è¦æ±‚",
      facing: "æœå‘ï¼ˆå¤§è‡´ï¼‰",
      sun: "æ—¥ç…§",
      secSurround: "å‘¨è¾¹â€œå½¢ç…â€ä¸ç¯å¢ƒ",
      secSurroundHint: "å™ªéŸ³/å·¥å‚/ç”µå¡”/å°–è§’ç­‰",
      sha: "å‘¨è¾¹æ˜¯å¦å­˜åœ¨ä»¥ä¸‹å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰",
      quiet: "æ•´ä½“æ¸…é™åº¦",
      green: "æ¤è¢«/ç»¿åŒ–",
      btnGenerate: "ç”Ÿæˆé£æ°´æŠ¥å‘Š",
      btnCopy: "å¤åˆ¶æŠ¥å‘Šæ–‡æœ¬",
      btnSave: "å¯¼å‡ºJSON",
      discTitle: "æç¤ºï¼š",
      discBody: "æœ¬å·¥å…·è¾“å‡ºä¸ºä¼ ç»Ÿæ°‘ä¿—è§’åº¦çš„â€œå‚è€ƒæ„è§â€ï¼Œä¸æ„æˆå®—æ•™/æ³•å¾‹/åŒ»å­¦å»ºè®®ã€‚è‹¥æ¶‰åŠå®‰è‘¬ï¼Œè¯·ä¼˜å…ˆéµå¾ªå½“åœ°æ³•å¾‹ã€å®—æ•™è§„èŒƒä¸å®¶å±æ„æ„¿ã€‚",
      resultTitle: "é£æ°´æŠ¥å‘Š",
      overallScore: "ç»¼åˆè¯„åˆ†ï¼ˆ0â€“100ï¼‰",
      breakdown: "åˆ†é¡¹è§£è¯»",
      recommend: "å»ºè®®ä¸é¿å‘",
      reportText: "å®Œæ•´æŠ¥å‘Šï¼ˆå¯å¤åˆ¶ï¼‰",
      reportExplain: "è¯„åˆ†è§„åˆ™ä¸ºâ€œå¯è§£é‡ŠåŠ æƒæ¨¡å‹â€ï¼Œåªåæ˜ ä¼ ç»Ÿè¦ç´ å¼ºå¼±ï¼Œä¸ä»£è¡¨ç°å®ä»·å€¼åˆ¤æ–­ã€‚",
      // options
      optUrban: "åŸå¸‚/è¿‘éƒŠ",
      optDesert: "æ²™æ¼ /æˆˆå£",
      optMountain: "å±±åœ°",
      optRural: "ä¹¡é‡/å†œç”°",
      optCoastal: "æ²¿æµ·",
      optUnknown: "æœªçŸ¥",
      optYin: "é˜´å®…ï¼ˆå¢“åœ°/é™µå›­ï¼‰",
      optYang: "é˜³å®…ï¼ˆä½å®…/å•†é“ºï¼‰",
      optCalm: "é£å°/æ¹¿æ¶¦",
      optNormal: "ä¸€èˆ¬",
      optWindy: "é£å¤§/é£æ²™",
      optStrong: "å¼ºï¼ˆæ˜æ˜¾é å±±/é«˜åœ°ï¼‰",
      optSome: "æœ‰ä¸€ç‚¹ï¼ˆç¼“å¡/è¿œå±±/å»ºç­‘ç¾¤ï¼‰",
      optFlat: "æ— ï¼ˆå¹³å¦/ç©ºæ—·ï¼‰",
      optGood: "è‰¯å¥½/è¾ƒä½³",
      optOk: "ä¸€èˆ¬",
      optOpen: "è¿‡äºå¼€é˜”ï¼ˆä¸èšï¼‰",
      optGentle: "å¾®å¡/ç¼“å¡ï¼ˆä¼˜ï¼‰",
      optSteep: "é™¡å¡ï¼ˆä¸ç¨³ï¼‰",
      optFirm: "åšå®/ä¸æ¾æ•£",
      optLoose: "æ¾æ•£/æ²™åœŸ",
      optMeander: "æœ‰ï¼ˆå¼¯ç¯/å¯èšï¼‰",
      optStraight: "æœ‰ï¼ˆç›´çº¿æ¸ /ç›´å†²ï¼‰",
      optNone: "æ— ",
      optMid: "ä¸€èˆ¬",
      optBad: "å·®/æ˜“ç§¯æ°´",
      optVeryClose: "å¾ˆè¿‘ï¼ˆ0â€“200mï¼‰",
      optClose: "è¾ƒè¿‘ï¼ˆ200â€“800mï¼‰",
      optFar: "è¾ƒè¿œï¼ˆ800m+ï¼‰",
      optStraightRoad: "ç›´çº¿/é•¿ç›´è·¯",
      optCurve: "å¼¯é“/ç¯æŠ±",
      optGrid: "æ£‹ç›˜è·¯ç½‘",
      optYes: "æ˜¯",
      optNo: "å¦",
      optSouth: "å—å‘",
      optEast: "ä¸œå‘",
      optWest: "è¥¿å‘",
      optNorth: "åŒ—å‘",
      optFixed: "æŒ‰å®—æ•™/è§„å®šå›ºå®šæœå‘",
      optPoor: "åå·®/é®æŒ¡",
      optVeryQuiet: "å¾ˆæ¸…é™",
      optNoisy: "ååµ",
      shaPylon: "é«˜å‹çº¿/ç”µå¡”",
      shaFactory: "å·¥å‚/çƒŸå°˜",
      shaNoise: "å™ªéŸ³ï¼ˆé«˜é€Ÿ/æœºåœºï¼‰",
      shaSharp: "å°–è§’/åˆ€åˆƒå½¢å»ºç­‘",
      shaDump: "åƒåœ¾åœº/æ±¡æ°´",
      shaNone: "æ— æ˜æ˜¾"
    },
    en: {
      appTitle: "Feng Shui Quick Assessment (Folklore Reference)",
      appSub: "Not scientific. This tool scores and explains classic factors (terrain / water / forms / facing / roads / wind / surroundings) to help compare sites and communicate.",
      inputTitle: "Inputs",
      inputHint: "Choose based on reality; select â€œUnknownâ€ if unsure.",
      secBasic: "Basic Info",
      secBasicHint: "Used for the report header/notes",
      siteName: "Site name (optional)",
      regionType: "Region type",
      purpose: "Use case",
      climate: "Climate / wind & sand",
      notes: "Extra notes (optional)",
      secLand: "Terrain & backing / embrace",
      secLandHint: "Classic: backing behind, table in front, guardians on sides",
      backing: "Backing (hill / higher ground / barrier)",
      embrace: "Embrace (left-right protection / enclosure)",
      slope: "Slope",
      ground: "Ground feel (subjective)",
      secWater: "Water & â€œQi gatheringâ€",
      secWaterHint: "Classic: water helps gather; avoid straight in-out",
      water: "Nearby water (river/lake/wetland/landscape water)",
      drainage: "Drainage / flooding risk",
      secRoad: "Roads / highways / â€œroad rushingâ€",
      secRoadHint: "Classic: straight rushing is harsh; curved embrace is softer",
      roadNear: "Distance to main road",
      roadShape: "Road pattern",
      roadHit: "Does the plot/gate face an incoming road (road rushing)?",
      secFacing: "Facing / sunlight / ventilation",
      secFacingHint: "Some places/religions require fixed orientation",
      facing: "Facing (approx.)",
      sun: "Sunlight",
      secSurround: "Surrounding â€œshaâ€ forms & environment",
      secSurroundHint: "Noise / factories / pylons / sharp corners etc.",
      sha: "Check surrounding factors (multi-select)",
      quiet: "Overall quietness",
      green: "Greenery",
      btnGenerate: "Generate report",
      btnCopy: "Copy report text",
      btnSave: "Export JSON",
      discTitle: "Note:",
      discBody: "Folklore reference only; not legal/religious/medical advice. For burials, follow local law, religious rules, and family consensus first.",
      resultTitle: "Report",
      overallScore: "Overall score (0â€“100)",
      breakdown: "Breakdown",
      recommend: "Suggestions & pitfalls",
      reportText: "Full report (copyable)",
      reportExplain: "This is an explainable weighted model that reflects traditional factor strength only.",
      // options
      optUrban: "Urban / suburb",
      optDesert: "Desert / arid",
      optMountain: "Mountain",
      optRural: "Rural / farmland",
      optCoastal: "Coastal",
      optUnknown: "Unknown",
      optYin: "Yin house (burial/cemetery)",
      optYang: "Yang house (residence/business)",
      optCalm: "Low wind / humid",
      optNormal: "Normal",
      optWindy: "Windy / sandy",
      optStrong: "Strong (clear backing)",
      optSome: "Some (gentle/remote backing)",
      optFlat: "None (flat/open)",
      optGood: "Good",
      optOk: "Okay",
      optOpen: "Too open (hard to gather)",
      optGentle: "Gentle slope (preferred)",
      optSteep: "Steep (unstable)",
      optFirm: "Firm / solid",
      optLoose: "Loose / sandy",
      optMeander: "Yes (meandering / can gather)",
      optStraight: "Yes (straight / rushing)",
      optNone: "None",
      optMid: "Medium",
      optBad: "Bad / pooling risk",
      optVeryClose: "Very close (0â€“200m)",
      optClose: "Close (200â€“800m)",
      optFar: "Far (800m+)",
      optStraightRoad: "Straight / long straight",
      optCurve: "Curved / embracing",
      optGrid: "Grid",
      optYes: "Yes",
      optNo: "No",
      optSouth: "South",
      optEast: "East",
      optWest: "West",
      optNorth: "North",
      optFixed: "Fixed by religion/regulation",
      optPoor: "Poor / blocked",
      optVeryQuiet: "Very quiet",
      optNoisy: "Noisy",
      shaPylon: "Power lines / pylons",
      shaFactory: "Factory / pollution",
      shaNoise: "Noise (highway/airport)",
      shaSharp: "Sharp / blade-like corners",
      shaDump: "Dump / sewage",
      shaNone: "No obvious issues"
    }
  };

  function setLang(lang){
    const dict = I18N[lang] || I18N.zh;
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      if(dict[key]) el.textContent = dict[key];
    });
    // update select option labels (with data-i18n on options)
    document.querySelectorAll("option[data-i18n]").forEach(opt=>{
      const key = opt.getAttribute("data-i18n");
      if(dict[key]) opt.textContent = dict[key];
    });
    document.documentElement.lang = (lang === "en" ? "en" : "zh-CN");
    window.__LANG__ = lang;
    // refresh tag label if exists
    if(window.__LAST_RESULT__) renderResult(window.__LAST_RESULT__);
  }

  // ---------------- helpers ----------------
  const $ = (id)=>document.getElementById(id);

  function getRadio(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : "unknown";
  }

  function getSha(){
    const checked = [...document.querySelectorAll("#shaGroup input[type=checkbox]:checked")].map(x=>x.value);
    // Normalize "none" vs others
    if(checked.includes("none") && checked.length > 1){
      // if both none and others selected, remove "none"
      return checked.filter(x=>x !== "none");
    }
    return checked.length ? checked : ["unknown"];
  }

  function nowStr(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  // ---------------- scoring model (explainable) ----------------
  // 0-100. Weights reflect classic folklore priorities for burial:
  // Terrain/backing 25, Embrace 15, Water 15, Road/å†² 20, Surrounding sha 15, Climate 5, Sun 5.
  function scoreModel(input){
    const w = {
      backing: 25,
      embrace: 15,
      water: 15,
      road: 20,
      sha: 15,
      climate: 5,
      sun: 5
    };

    // backing
    let sBacking = ({
      strong: 100,
      some: 70,
      flat: 35,
      unknown: 55
    })[input.backing] ?? 55;

    // embrace
    let sEmbrace = ({
      good: 90,
      ok: 65,
      open: 35,
      unknown: 55
    })[input.embrace] ?? 55;

    // slope/ground adjust (minor)
    const slopeAdj = ({
      gentle: +6,
      flat: 0,
      steep: -8,
      unknown: 0
    })[input.slope] ?? 0;

    const groundAdj = ({
      firm: +5,
      normal: 0,
      loose: -8,
      unknown: 0
    })[input.ground] ?? 0;

    sBacking = clamp(sBacking + slopeAdj + groundAdj, 0, 100);

    // water
    let sWater = ({
      meander: 85,
      straight: 55,
      none: 35,
      unknown: 55
    })[input.water] ?? 55;

    // drainage adjust
    const drainageAdj = ({
      good: +6,
      mid: 0,
      bad: -10,
      unknown: 0
    })[input.drainage] ?? 0;

    sWater = clamp(sWater + drainageAdj, 0, 100);

    // road
    // distance baseline
    let sRoadDist = ({
      veryClose: 35,
      close: 55,
      far: 75,
      unknown: 60
    })[input.roadNear] ?? 60;

    // shape baseline
    let sRoadShape = ({
      straight: 45,
      curve: 70,
      grid: 55,
      unknown: 60
    })[input.roadShape] ?? 60;

    let sRoadHit = (input.roadHit === "yes") ? 25 : (input.roadHit === "no" ? 70 : 55);

    // combine road subscore
    let sRoad = clamp((sRoadDist*0.4 + sRoadShape*0.25 + sRoadHit*0.35), 0, 100);

    // sha environment
    const shaList = input.sha;
    let sShaBase = 70; // assume acceptable
    if(shaList.includes("unknown")) sShaBase = 60;
    if(shaList.includes("none")) sShaBase = 75;

    // each negative sha reduces
    const shaPenaltyMap = { pylon: 10, factory: 12, noise: 10, sharp: 8, dump: 14 };
    let penalty = 0;
    shaList.forEach(k => penalty += (shaPenaltyMap[k] || 0));

    // quietness adjustment
    const quietAdj = ({ veryQuiet: +6, ok: 0, noisy: -8, unknown: 0 })[input.quiet] ?? 0;
    // greenery adjustment
    const greenAdj = ({ good: +5, mid: 0, none: -6, unknown: 0 })[input.green] ?? 0;

    let sSha = clamp(sShaBase - penalty + quietAdj + greenAdj, 0, 100);

    // climate (wind/sand)
    let sClimate = ({ calm: 75, normal: 60, windy: 40, unknown: 55 })[input.climate] ?? 55;

    // sun
    let sSun = ({ good: 70, mid: 55, poor: 40, unknown: 55 })[input.sun] ?? 55;

    // overall weighted
    const total =
      sBacking*w.backing +
      sEmbrace*w.embrace +
      sWater*w.water +
      sRoad*w.road +
      sSha*w.sha +
      sClimate*w.climate +
      sSun*w.sun;

    const overall = Math.round(total / 100);

    // build breakdown
    const breakdown = [
      { key:"backing", label:"åœ°åŠ¿/é å±±", score: Math.round(sBacking), weight:w.backing },
      { key:"embrace", label:"ç¯æŠ±/æŠ¤ç ‚", score: Math.round(sEmbrace), weight:w.embrace },
      { key:"water",   label:"æ°´/æ’æ°´", score: Math.round(sWater), weight:w.water },
      { key:"road",    label:"é“è·¯/è·¯å†²", score: Math.round(sRoad), weight:w.road },
      { key:"sha",     label:"å‘¨è¾¹å½¢ç…/ç¯å¢ƒ", score: Math.round(sSha), weight:w.sha },
      { key:"climate", label:"é£æ²™/æ°”å€™", score: Math.round(sClimate), weight:w.climate },
      { key:"sun",     label:"æ—¥ç…§", score: Math.round(sSun), weight:w.sun }
    ];

    return { overall, breakdown, subs: { sBacking, sEmbrace, sWater, sRoad, sSha, sClimate, sSun } };
  }

  function bandTag(score){
    const lang = window.__LANG__ || "zh";
    if(score >= 75) return { cls:"good", text: (lang==="en" ? "Favorable" : "åå‰ï¼ˆè¾ƒå¥½ï¼‰") };
    if(score >= 55) return { cls:"mid", text: (lang==="en" ? "Mixed" : "ä¸­æ€§ï¼ˆå¯ç”¨ï¼‰") };
    return { cls:"bad", text: (lang==="en" ? "Challenging" : "åå¼±ï¼ˆéœ€è°¨æ…ï¼‰") };
  }

  function zhLabelForBreakKey(key){
    const m = { backing:"åœ°åŠ¿/é å±±", embrace:"ç¯æŠ±/æŠ¤ç ‚", water:"æ°´/æ’æ°´", road:"é“è·¯/è·¯å†²", sha:"å‘¨è¾¹å½¢ç…/ç¯å¢ƒ", climate:"é£æ²™/æ°”å€™", sun:"æ—¥ç…§" };
    return m[key] || key;
  }

  function enLabelForBreakKey(key){
    const m = { backing:"Terrain/Backing", embrace:"Enclosure", water:"Water/Drainage", road:"Road Impact", sha:"Surroundings", climate:"Climate", sun:"Sunlight" };
    return m[key] || key;
  }

  function keyAdvice(input, result){
    const lang = window.__LANG__ || "zh";
    const adv = [];
    const { subs } = result;

    // road rushing
    if(input.roadHit === "yes" || subs.sRoad < 45){
      adv.push(lang==="en"
        ? "Avoid a plot/gate directly facing a long straight road. If unavoidable, use landscaping/walls/curved approach to soften the rush."
        : "å°½é‡é¿å…å¢“ä½/å…¥å£æ­£å¯¹é•¿ç›´è·¯ï¼ˆè·¯å†²ï¼‰ã€‚è‹¥æ— æ³•é¿å…ï¼Œå¯ç”¨ç»¿åŒ–ã€å›´å¢™ã€æ›²æŠ˜å…¥å›­è·¯å¾„æ¥â€œç¼“å†²â€ã€‚");
    }

    // too open / no backing
    if(input.backing === "flat" || input.embrace === "open" || subs.sBacking < 50){
      adv.push(lang==="en"
        ? "Open flat terrain is hard to â€œgatherâ€. Prefer sites with a gentle rise behind or clear side protection."
        : "å¹³å¦ç©ºæ—·åœ°â€œæ°”æ˜“æ•£â€ã€‚ä¼˜å…ˆé€‰èƒŒåå¾®é«˜/æœ‰å±éšœã€å·¦å³æœ‰æŠ¤çš„ç‚¹ä½ã€‚");
    }

    // water none / drainage
    if(input.water === "none" || subs.sWater < 45){
      adv.push(lang==="en"
        ? "Lack of water is common in arid regions; focus on drainage design and avoid low-lying pockets where water can pool."
        : "ç¼ºæ°´åœ¨å¹²æ—±åŒºå¾ˆå¸¸è§ï¼Œé‡ç‚¹åè€Œæ˜¯æ’æ°´ï¼šé¿å¼€ä½æ´¼æ˜“ç§¯æ°´ç‚¹ï¼Œç¡®ä¿é›¨å­£æ’æ°´é€šç•…ã€‚");
    }

    // sand/wind
    if(input.climate === "windy"){
      adv.push(lang==="en"
        ? "In windy/sandy areas, consider windbreak trees/walls, and choose locations less exposed to prevailing winds."
        : "é£å¤§/é£æ²™åŒºï¼Œå»ºè®®é€‰ç›¸å¯¹èƒŒé£ä½ç½®ï¼Œå¹¶è€ƒè™‘é˜²é£æ—/å›´æŒ¡ï¼Œå‡å°‘â€œç‡¥æ•£â€ã€‚");
    }

    // sha
    const sha = input.sha || [];
    const shaHints = {
      pylon: lang==="en" ? "Keep distance from pylons/power lines." : "å°½é‡è¿œç¦»é«˜å‹çº¿/ç”µå¡”ã€‚",
      factory: lang==="en" ? "Avoid industrial pollution/odors." : "é¿å¼€å·¥å‚çƒŸå°˜/å¼‚å‘³ã€‚",
      noise: lang==="en" ? "Noise reduces â€œquiet qiâ€; choose deeper, buffered plots." : "å™ªéŸ³ä¼šç ´â€œæ¸…é™æ°”â€ï¼Œé€‰æ›´æ·±ã€æ›´æœ‰ç¼“å†²çš„ç‚¹ä½ã€‚",
      sharp: lang==="en" ? "Avoid sharp-corner sight lines pointing to the plot." : "é¿å¼€å°–è§’ç›´æŒ‡çš„è§†çº¿ã€‚",
      dump: lang==="en" ? "Avoid dumps/sewage and stagnant water." : "è¿œç¦»åƒåœ¾/æ±¡æ°´ä¸ç§¯æ°´æºã€‚"
    };
    sha.forEach(k=>{
      if(shaHints[k]) adv.push(shaHints[k]);
    });

    // facing
    if(input.facing === "fixed"){
      adv.push(lang==="en"
        ? "If orientation is fixed by religion/regulation, prioritize terrain/road/drainage improvements instead of forcing classic facing rules."
        : "è‹¥æœå‘ç”±å®—æ•™/è§„å®šå›ºå®šï¼Œä¼˜å…ˆæŠŠåœ°åŠ¿ã€é“è·¯ç¼“å†²ã€æ’æ°´ä¸ç¯å¢ƒåšå¥½ï¼Œä¸å¿…å¼ºè¡Œå¥—ä¼ ç»Ÿâ€œå‘â€ã€‚");
    }

    if(!adv.length){
      adv.push(lang==="en"
        ? "Overall looks balanced. Verify on-site (noise, drainage, wind), and choose a plot with slight backing and buffered access."
        : "æ•´ä½“è¾ƒå‡è¡¡ã€‚å»ºè®®å®åœ°ç¡®è®¤å™ªéŸ³/æ’æ°´/é£å‘ï¼Œå¹¶ä¼˜å…ˆé€‰æ‹©èƒŒåç•¥æœ‰ä¾é ã€è¿›å‡ºé“è·¯æ›´ç¼“çš„ç‚¹ä½ã€‚");
    }
    return adv.slice(0, 8);
  }

  function breakdownText(input, result){
    const lang = window.__LANG__ || "zh";
    return result.breakdown.map(item=>{
      const label = (lang==="en") ? enLabelForBreakKey(item.key) : zhLabelForBreakKey(item.key);
      const w = item.weight;
      let note = "";
      if(item.score >= 75) note = (lang==="en" ? "strong" : "è¾ƒå¼º");
      else if(item.score >= 55) note = (lang==="en" ? "ok" : "ä¸€èˆ¬");
      else note = (lang==="en" ? "weak" : "åå¼±");
      return { label, score: item.score, weight:w, note };
    });
  }

  function makeReport(input, result){
    const lang = window.__LANG__ || "zh";
    const tag = bandTag(result.overall);
    const name = (input.siteName || (lang==="en" ? "Unnamed site" : "æœªå‘½ååœ°ç‚¹"));
    const t = nowStr();

    const btxt = breakdownText(input, result)
      .map(x => (lang==="en"
        ? `- ${x.label}: ${x.score}/100 (${x.note}), weight ${x.weight}%`
        : `- ${x.label}ï¼š${x.score}/100ï¼ˆ${x.note}ï¼‰ï¼Œæƒé‡ ${x.weight}%`
      )).join("\n");

    const adv = keyAdvice(input, result).map(s => `- ${s}`).join("\n");

    const header = (lang==="en"
      ? `Feng Shui Folklore Report\nSite: ${name}\nTime: ${t}\nOverall: ${result.overall}/100 (${tag.text})\n`
      : `é£æ°´æ°‘ä¿—å‚è€ƒæŠ¥å‘Š\nåœ°ç‚¹ï¼š${name}\næ—¶é—´ï¼š${t}\nç»¼åˆï¼š${result.overall}/100ï¼ˆ${tag.text}ï¼‰\n`
    );

    const context = (lang==="en"
      ? `\nContext\n- Region: ${input.regionType}\n- Use: ${input.purpose}\n- Climate: ${input.climate}\n- Facing: ${input.facing}\n- Notes: ${input.notes || "(none)"}\n`
      : `\nåŸºæœ¬æƒ…å†µ\n- åŒºåŸŸï¼š${input.regionType}\n- ç”¨é€”ï¼š${input.purpose}\n- æ°”å€™/é£æ²™ï¼š${input.climate}\n- æœå‘ï¼š${input.facing}\n- å¤‡æ³¨ï¼š${input.notes || "ï¼ˆæ— ï¼‰"}\n`
    );

    const body = (lang==="en"
      ? `\nBreakdown\n${btxt}\n\nSuggestions\n${adv}\n\nDisclaimer\nThis is folklore reference only; follow local laws and religious rules for burial decisions.`
      : `\nåˆ†é¡¹è§£è¯»\n${btxt}\n\nå»ºè®®ä¸é¿å‘\n${adv}\n\nå…è´£å£°æ˜\næœ¬æŠ¥å‘Šä¸ºæ°‘ä¿—å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹/å®—æ•™å»ºè®®ï¼›å®‰è‘¬è¯·ä¼˜å…ˆéµå¾ªå½“åœ°æ³•å¾‹ä¸å®—æ•™è§„èŒƒã€‚`
    );

    return header + context + body;
  }

  function renderResult(payload){
    const { input, result, reportText } = payload;
    window.__LAST_RESULT__ = payload;

    const tag = bandTag(result.overall);
    $("scoreVal").textContent = result.overall;
    $("scoreTag").className = `tag ${tag.cls}`;
    $("scoreTag").textContent = tag.text;
    $("scoreBar").style.width = `${clamp(result.overall,0,100)}%`;

    const lang = window.__LANG__ || "zh";
    $("reportMeta").textContent = (lang==="en"
      ? `${input.siteName || "Unnamed site"} Â· ${nowStr()}`
      : `${input.siteName || "æœªå‘½ååœ°ç‚¹"} Â· ${nowStr()}`
    );

    // breakdown list
    const bl = $("breakList");
    bl.innerHTML = "";
    breakdownText(input, result).forEach(x=>{
      const li = document.createElement("li");
      li.textContent = (lang==="en"
        ? `${x.label}: ${x.score}/100 (${x.note})`
        : `${x.label}ï¼š${x.score}/100ï¼ˆ${x.note}ï¼‰`
      );
      bl.appendChild(li);
    });

    // advice list
    const al = $("advList");
    al.innerHTML = "";
    keyAdvice(input, result).forEach(s=>{
      const li = document.createElement("li");
      li.textContent = s;
      al.appendChild(li);
    });

    $("reportTextBox").textContent = reportText;
  }

  function collectInput(){
    const input = {
      siteName: $("siteName").value.trim(),
      regionType: $("regionType").value,
      purpose: $("purpose").value,
      climate: $("climate").value,
      notes: $("notes").value.trim(),

      backing: $("backing").value,
      embrace: $("embrace").value,
      slope: $("slope").value,
      ground: $("ground").value,

      water: $("water").value,
      drainage: $("drainage").value,

      roadNear: $("roadNear").value,
      roadShape: $("roadShape").value,
      roadHit: getRadio("roadHit"),

      facing: $("facing").value,
      sun: $("sun").value,

      sha: getSha(),
      quiet: $("quiet").value,
      green: $("green").value
    };
    return input;
  }

  function calculate(){
    const input = collectInput();
    const result = scoreModel(input);
    const reportText = makeReport(input, result);
    renderResult({ input, result, reportText });
  }

  function resetAll(){
    document.querySelectorAll("input[type=text], input[type=number], textarea").forEach(el=>el.value="");
    document.querySelectorAll("select").forEach(sel=>{
      // keep language select
      if(sel.id === "langSel") return;
      sel.selectedIndex = 0;
    });
    document.querySelectorAll("input[type=radio]").forEach(r=>{
      if(r.name === "roadHit" && r.value === "no") r.checked = true;
    });
    document.querySelectorAll("#shaGroup input[type=checkbox]").forEach(c=>c.checked=false);

    $("scoreVal").textContent = "â€”";
    $("scoreTag").className = "tag mid";
    $("scoreTag").textContent = "â€”";
    $("scoreBar").style.width = "0%";
    $("breakList").innerHTML = "";
    $("advList").innerHTML = "";
    $("reportTextBox").textContent = "â€”";
    $("reportMeta").textContent = "â€”";
    window.__LAST_RESULT__ = null;
  }

  function demoFill(){
    // A desert cemetery near straight highway example
    $("siteName").value = "Example: Desert cemetery near highway";
    $("regionType").value = "desert";
    $("purpose").value = "yinzhai";
    $("climate").value = "windy";
    $("notes").value = "Near straight highway; flat open terrain; little greenery; planned cemetery grid roads.";

    $("backing").value = "flat";
    $("embrace").value = "open";
    $("slope").value = "flat";
    $("ground").value = "loose";

    $("water").value = "none";
    $("drainage").value = "mid";

    $("roadNear").value = "close";
    $("roadShape").value = "grid";
    document.querySelector(`input[name="roadHit"][value="unknown"]`).checked = true;

    $("facing").value = "fixed";
    $("sun").value = "good";

    // sha
    document.querySelectorAll("#shaGroup input[type=checkbox]").forEach(c=>c.checked=false);
    document.querySelector(`#shaGroup input[value="noise"]`).checked = true;
    document.querySelector(`#shaGroup input[value="none"]`).checked = false;

    $("quiet").value = "veryQuiet";
    $("green").value = "none";

    calculate();
  }

  async function copyReport(){
    const text = $("reportTextBox").textContent;
    if(!text || text === "â€”") return;
    try{
      await navigator.clipboard.writeText(text);
      flashBtn($("btnCopy"), "âœ…");
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      flashBtn($("btnCopy"), "âœ…");
    }
  }

  function exportJSON(){
    const input = collectInput();
    const result = scoreModel(input);
    const payload = { input, result, generatedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "fengshui_report.json";
    a.click();
    URL.revokeObjectURL(a.href);
    flashBtn($("btnSave"), "âœ…");
  }

  function flashBtn(btn, mark){
    const old = btn.textContent;
    btn.textContent = mark + " " + old.replace(/^âœ…\s|^âœ¨\s/,"");
    btn.style.borderColor = "rgba(34,197,94,.6)";
    setTimeout(()=>{
      btn.textContent = old;
      btn.style.borderColor = "";
    }, 900);
  }

  // ---------------- events ----------------
  $("btnCalc").addEventListener("click", calculate);
  $("btnCalc2").addEventListener("click", calculate);
  $("btnReset").addEventListener("click", resetAll);
  $("btnDemo").addEventListener("click", demoFill);
  $("btnCopy").addEventListener("click", copyReport);
  $("btnSave").addEventListener("click", exportJSON);

  $("langSel").addEventListener("change", (e)=> setLang(e.target.value));

  // initial
  window.__LANG__ = "zh";
  setLang("zh");
</script>
</body>
</html>
